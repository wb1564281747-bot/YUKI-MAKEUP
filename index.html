<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>YUKI MAKEUP</title>

  <!-- PWA -->
  <meta name="theme-color" content="#ffffff" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="åŒ–å¦†åº—ç³»ç»Ÿ">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <!-- Icons removed in standalone file:// mode to avoid noisy 404 errors. -->

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">

  <style>
    body { background:#f7f7f8; padding-bottom: 74px; }
    .card { border-radius: 16px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small-muted { color:#6c757d; font-size: 12px; }
    .pill { border-radius: 999px; padding: 2px 10px; font-size: 12px; display:inline-block; }
    .required::after { content:" *"; color:#dc3545; }

    #calendarWrap { background:#fff; border-radius:16px; padding: 10px; }
    .fc { background:#fff; }
    .fc .fc-toolbar-title { font-size: 16px; }
    .fc .fc-button { padding: .25rem .4rem; font-size: 12px; }
    .fc .fc-col-header-cell-cushion, .fc .fc-daygrid-day-number { font-size: 12px; }

    /* âœ… ä¿®å¤ iPhone ç‚¹å‡»ä¸åˆ°ä¿å­˜ï¼šä¸è¦è®©åº•éƒ¨å¯¼èˆªå‹ä½ modal */
    .bottom-nav {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: #fff;
      border-top: 1px solid #e9ecef;
      padding: 8px 10px;
      z-index: 1020; /* ä½äº bootstrap modal */
      padding-bottom: calc(8px + env(safe-area-inset-bottom));
    }
    .bottom-nav .btn { flex: 1; border-radius: 14px; padding: 10px 0; font-size: 13px; }

    @media (max-width: 576px) {
      .modal-dialog { margin: 0; max-width: 100%; height: 100%; }
      .modal-content { height: 100%; border-radius: 0 !important; }
      .modal-body { overflow-y: auto; padding-bottom: calc(16px + env(safe-area-inset-bottom)); }
      .container { padding-left: 12px; padding-right: 12px; }
    }

    .svc-item { border:1px solid #e9ecef; border-radius:14px; padding:10px; background:#fff; }
    .section-title { font-weight: 600; }

    .ios-install-tip {
      position: sticky;
      top: 56px;
      z-index: 1070;
      background: #fff3cd;
      border: 1px solid #ffe69c;
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 12px;
      display: none;
    }
  
/* ===== Calendar payment status colors (Day/Week/Month) ===== */
.fc-event.paid-full,
.fc-daygrid-event.paid-full {
  background-color: #2ecc71 !important;
  border-color: #2ecc71 !important;
  color: #fff !important;
}
.fc-event.paid-deposit,
.fc-daygrid-event.paid-deposit {
  background-color: #e74c3c !important;
  border-color: #e74c3c !important;
  color: #fff !important;
}
.fc-daygrid-event.paid-full .fc-daygrid-event-dot { border-color: #2ecc71 !important; }
.fc-daygrid-event.paid-deposit .fc-daygrid-event-dot { border-color: #e74c3c !important; }

</style>
</head>

<body>
<nav class="navbar bg-white border-bottom sticky-top">
  <div class="container d-flex justify-content-between align-items-center">
    <span class="navbar-brand mb-0 fw-semibold" id="appTitle">ğŸ’„ YUKI MAKEUP </span>
    <div class="d-flex gap-2 align-items-center">
      <button class="btn btn-outline-primary btn-sm" id="btnSync">åŒæ­¥åˆ·æ–°</button>
      <button class="btn btn-outline-secondary btn-sm" id="btnShopInfo">åº—é“º</button>
    </div>
  </div>
</nav>

<div class="container my-3">
  <div class="ios-install-tip" id="iosTip">
    <div class="fw-semibold">ğŸ“Œ å»ºè®®æ·»åŠ åˆ°ä¸»å±å¹•</div>
    <div class="small-muted">Safari ç‚¹ã€åˆ†äº«ã€‘â†’ã€æ·»åŠ åˆ°ä¸»å±å¹•ã€‘ï¼Œä»¥ååƒ App ä¸€æ ·å…¨å±æ‰“å¼€ã€‚</div>
  </div>

  <!-- App -->
  <div id="app">
    <div id="pageCalendar" class="page">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="section-title">ğŸ“… é¢„çº¦</div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary btn-sm" id="btnNewBooking">æ–°å¢é¢„çº¦</button>        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
        <label class="small-muted mb-0">åŒ–å¦†å¸ˆ</label>
        <select class="form-select form-select-sm w-auto" id="calStaffFilter"></select>
      </div>

      <div class="card shadow-sm">
        <div class="card-body p-2">
          <div id="calendar"></div>
        </div>
      </div>
    </div>

    

<div id="pageStaff" class="page d-none">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div class="section-title">åŒ–å¦†å¸ˆ</div>
        <div class="small-muted" id="staffCount">å…± 0 ä½</div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" id="btnClearStaff" type="button">æ¸…ç©º</button>
        <button class="btn btn-primary" id="btnSaveStaff" type="button">ä¿å­˜</button>
      </div>
    </div>

    <div class="card shadow-sm mt-2">
      <div class="card-body">
        <input type="hidden" id="staffId">
        <div class="row g-2">
          <div class="col-12">
            <label class="form-label required">å§“å</label>
            <input class="form-control" id="staffName" placeholder="ä¾‹å¦‚ï¼šå°é›¨">
          </div>
          <div class="col-6">
            <label class="form-label">ææˆæ–¹å¼</label>
            <select class="form-select" id="commissionType">
              <option value="percent">æŒ‰æ¯”ä¾‹ï¼ˆ%ï¼‰</option>
              <option value="fixed">å›ºå®šé‡‘é¢ï¼ˆå…ƒ/å•ï¼‰</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label">ææˆæ•°å€¼</label>
            <input class="form-control" id="commissionValue" type="number" min="0" step="0.01" placeholder="ä¾‹å¦‚ï¼š10 æˆ– 50">
          </div>
        </div>
        <div class="small-muted mt-2">æç¤ºï¼šå…ˆç‚¹â€œä¿å­˜â€ç”ŸæˆåŒ–å¦†å¸ˆï¼Œå†åœ¨ä¸‹æ–¹æ·»åŠ é¡¹ç›®ã€‚</div>
      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <div class="section-title">é¡¹ç›®/é‡‘é¢</div>
        <div class="row g-2 align-items-end">
          <div class="col-7">
            <label class="form-label">é¡¹ç›®åç§°</label>
            <input class="form-control" id="svcName" placeholder="ä¾‹å¦‚ï¼šæ–°å¨˜å¦†">
          </div>
          <div class="col-5">
            <label class="form-label">é‡‘é¢</label>
            <input class="form-control" id="svcPrice" type="number" min="0" step="0.01" placeholder="ä¾‹å¦‚ï¼š1299">
          </div>
          <div class="col-6 d-grid">
            <button class="btn btn-outline-secondary" id="btnClearServiceInput" type="button">æ¸…ç©ºè¾“å…¥</button>
          </div>
          <div class="col-6 d-grid">
            <button class="btn btn-outline-primary" id="btnAddService" type="button">æ·»åŠ é¡¹ç›®</button>
          </div>
        </div>

        <div class="mt-3" id="serviceList">
          <div class="small-muted">å…ˆä¿å­˜/é€‰æ‹©åŒ–å¦†å¸ˆï¼Œå†æ·»åŠ é¡¹ç›®ã€‚</div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-body">
        <div class="section-title">åŒ–å¦†å¸ˆåˆ—è¡¨</div>
        <div id="staffCards" class="vstack gap-2 mt-2"><div class="small-muted">åŠ è½½ä¸­â€¦</div></div>
      </div>
    </div>
  </div>
</div>

<div id="pageReports" class="page d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="section-title">ğŸ“Š æŠ¥è¡¨</div>
        <button class="btn btn-primary btn-sm" id="btnRunReport">ç”Ÿæˆ</button>
      </div>

      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">å¼€å§‹</label>
              <input type="date" class="form-control" id="repStart">
            </div>
            <div class="col-6">
              <label class="form-label">ç»“æŸ</label>
              <input type="date" class="form-control" id="repEnd">
            </div>
          </div>
        </div>
      </div>

      <div class="row g-2">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="small-muted">è¥ä¸šé¢ï¼ˆåº”æ”¶ï¼Œæ’é™¤ä½œåºŸï¼‰</div>
              <div class="fs-3 fw-semibold mono" id="repTotal">0.00</div>
            </div>
          </div>
        </div>

        <div class="col-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="small-muted">å®æ”¶</div>
              <div class="fs-5 fw-semibold mono" id="repPaid">0.00</div>
            </div>
          </div>
        </div>
        <div class="col-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="small-muted">æœªæ”¶</div>
              <div class="fs-5 fw-semibold mono" id="repUnpaid">0.00</div>
            </div>
          </div>
        </div>

        
        
      </div>

      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="section-title">æŒ‰åŒ–å¦†å¸ˆç»Ÿè®¡</div>
          <div id="repStaffCards" class="vstack gap-2 mt-2"></div>
        </div>
      </div>

      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="section-title">æœªç»“æ¸…è´¦å•</div>
          <div class="small-muted">æ–¹ä¾¿è¿½å°¾æ¬¾ï¼ˆä¸å«ä½œåºŸï¼‰</div>
          <div id="repOpenInvoices" class="vstack gap-2 mt-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bottom nav -->
<div class="bottom-nav" id="bottomNav">
  <div class="container d-flex gap-2">
    <button class="btn btn-outline-primary" data-page="Calendar">é¢„çº¦</button>
    <button class="btn btn-outline-primary" data-page="Staff">åŒ–å¦†å¸ˆ</button>
    <button class="btn btn-outline-primary" data-page="Reports">æŠ¥è¡¨</button>
  </div>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content" style="border-radius: 16px;">
      <div class="modal-header">
        <h5 class="modal-title">é¢„çº¦å•</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="bookingId">

        <div class="mb-2">
          <label class="form-label required">å®¢æˆ·å§“å</label>
          <input class="form-control" id="custName" placeholder="ä¾‹å¦‚ï¼šå¼ å°å§">
        </div>
        <div class="mb-2">
          <label class="form-label">æ‰‹æœºå·</label>
          <input class="form-control" id="custPhone" placeholder="å¯é€‰">
        </div>

        <div class="mb-2">
          <label class="form-label required">åŒ–å¦†å¸ˆ</label>
          <select class="form-select" id="staffSelect"></select>
        </div>

        <div class="mb-2">
          <label class="form-label required">æœåŠ¡é¡¹ç›®</label>
          <select class="form-select" id="serviceSelect"></select>
          <div class="small-muted mt-1">é¡¹ç›®æ¥è‡ªè¯¥åŒ–å¦†å¸ˆçš„â€œé¡¹ç›®/é‡‘é¢â€ã€‚</div>
          <div class="mt-2" id="bookingPayBar">
            <div class="small-muted" id="bookingPayInfo">å®šé‡‘/å°¾æ¬¾ï¼šæœªç”Ÿæˆè´¦å•</div>
            <div class="row g-2 mt-2 align-items-end">
              <div class="col-7">
                <label class="form-label mb-1">å·²æ”¶å®šé‡‘ï¼ˆå…ƒï¼‰</label>
                <input class="form-control" id="bookingDepositPaid" type="number" min="0" step="0.01" placeholder="å¯ç›´æ¥å¡«å†™ï¼Œå¦‚ 200">
              </div>
              <div class="col-5 d-grid">
                <button class="btn btn-outline-success" type="button" id="btnBookingPaidAll">ç»“æ¸…å°¾æ¬¾</button>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-2">
          <div class="col-6">
            <label class="form-label required">æ—¥æœŸ</label>
            <input class="form-control" id="bookDate" type="date">
          </div>
          <div class="col-6">
            <label class="form-label">é¢„çº¦çŠ¶æ€</label>
            <select class="form-select" id="bookingStatus">
              <option value="å·²é¢„çº¦">å·²é¢„çº¦</option>
              <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
              <option value="å·²å–æ¶ˆ">å·²å–æ¶ˆ</option>
            </select>
            <div class="small-muted mt-1">è¯´æ˜ï¼šè¿™æ˜¯é¢„çº¦æµç¨‹çŠ¶æ€ï¼ˆå·²é¢„çº¦/å·²å®Œæˆ/å·²å–æ¶ˆï¼‰ï¼Œä¸ç­‰åŒäºå®šé‡‘/å°¾æ¬¾çŠ¶æ€ã€‚</div>
          </div>
        </div>

        <div class="row g-2 mt-1">
          <div class="col-6">
            <label class="form-label required">å¼€å§‹æ—¶é—´</label>
            <input class="form-control" id="startTime" type="time">
          </div>
          <div class="col-6">
            <label class="form-label required">ç»“æŸæ—¶é—´</label>
            <input class="form-control" id="endTime" type="time">
          </div>
        </div>

        <div class="mt-2">
          <label class="form-label">å¤‡æ³¨</label>
          <input class="form-control" id="bookingNote" placeholder="ä¾‹å¦‚ï¼šä¸Šé—¨ / éœ€è‡ªå¸¦å‡ç«æ¯›">
        </div>

        <div class="alert alert-warning mt-3 d-none" id="conflictAlert"></div>
        <div class="small-muted">é˜²å†²çªï¼šåŒä¸€åŒ–å¦†å¸ˆåŒä¸€æ—¶é—´æ®µä¸å¯é‡å¤é¢„çº¦ï¼ˆå·²å–æ¶ˆä¸ç®—å†²çªï¼‰ã€‚</div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-danger me-auto" id="btnDeleteBooking">åˆ é™¤</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">å…³é—­</button>
        <button class="btn btn-primary" id="btnSaveBooking">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- Invoice Modal -->
</div>

<!-- Owner Lock Modal (Mode B) -->
<div class="modal fade" id="lockModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px;">
      <div class="modal-header">
        <h5 class="modal-title">ğŸ”’ é”</h5>
      </div>
      <div class="modal-body">
        <div class="small-muted mb-2" id="lockTip">è¿›å…¥è´¦å•/æŠ¥è¡¨éœ€è¦å¯†ç </div>

        <div class="mb-2">
          <label class="form-label required" id="lockLabel">å¯†ç ï¼ˆ4~6ä½æ•°å­—ï¼‰</label>
          <input id="lockPin" class="form-control" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="è¯·è¾“å…¥æ•°å­—å¯†ç ">
        </div>

        <div class="alert alert-danger d-none" id="lockErr"></div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-outline-secondary flex-grow-1" id="lockCancel">å–æ¶ˆ</button>
          <button class="btn btn-primary flex-grow-1" id="lockOk">ç¡®å®š</button>
        </div>

        <hr class="my-3"/>

        <button class="btn btn-outline-danger w-100" id="lockReset">å¿˜è®°å¯†ç /é‡è®¾ï¼ˆéœ€è¦ç¡®è®¤ï¼‰</button>
        <div class="small-muted mt-2">å¯†ç å¤šè®¾å¤‡ç”Ÿæ•ˆã€‚</div>
      </div>
    </div>
  </div>
</div>

<!-- Shop info modal -->
<div class="modal fade" id="shopModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px;">
      <div class="modal-header">
        <h5 class="modal-title">ğŸª åº—é“ºä¿¡æ¯</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="small-muted">å½“å‰åº—é“º</div>
        <div class="fw-semibold" id="shopTitle">-</div>
        <div class="small-muted mt-2">åº—é“ºç ï¼ˆå±•ç¤ºç”¨ï¼‰</div>
        <div class="mono fs-5" id="shopCode">-</div>
        <div class="small-muted mt-2">å½“å‰ shop_id</div>
        <div class="mono" id="shopIdText">-</div>
        <button class="btn btn-outline-primary w-100 mt-3" id="btnCopyShopId">å¤åˆ¶ shop_id</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
  <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastText">å·²ä¿å­˜</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// DOM helpers (é˜²æ­¢å…ƒç´ ä¸å­˜åœ¨å¯¼è‡´ addEventListener æŠ¥é”™)
const $ = (id) => document.getElementById(id);
function on(id, evt, handler) {
  const el = $(id);
  if (!el) {
    // æŸäº›åŠŸèƒ½è¢«åˆ æ‰åï¼Œç›¸å…³ DOM å¯èƒ½ä¸å­˜åœ¨ï¼›è¿™é‡Œç›´æ¥è·³è¿‡ç»‘å®š
    return;
  }
  el.addEventListener(evt, handler);
}

/********************
 * Configï¼ˆä½ çš„ï¼‰
 ********************/
const SUPABASE_URL = "https://pqnrhzmhnajezkivpfks.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxbnJoem1obmFqZXpraXZwZmtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MzkzMjUsImV4cCI6MjA4NDAxNTMyNX0.NqnjHHhAxZIloSRdBPIApNZi4e_lVb57MUSXBxxmbWc";
const SHOP_ID = "71798af3-a79e-4ffb-90d5-5026513233a1";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const DEFAULT_DEPOSIT = 500;

/********************

* é¡µé¢é” Page Lock 2.0 é…ç½®
  ********************/

// ç®¡ç†å‘˜é‡ç½®å¯†ç ï¼ˆä»…ç”¨äºé‡ç½®é¡µé¢é”ï¼‰
const ADMIN_RESET_PIN = "156428";

// é¡µé¢é”è¿è¡Œæ€
let __pageUnlocked = false;

/********************
 * iPhone install tip + SW
 ********************/
(function () {
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isInStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
  const isSafari = isIOS && /safari/i.test(navigator.userAgent) && !/crios|fxios|edgios/i.test(navigator.userAgent);
  const tip = document.getElementById("iosTip");
  if (isSafari && !isInStandalone) tip.style.display = "block";
  if (location.protocol === "http:" || location.protocol === "https:") {
    if ("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
})();
</script>

<script>
/********************
 * In-Memory DB (cloud-backed)
 ********************/
let DB = { staff: [], bookings: [], invoices: [] };

let currentShop = { id: SHOP_ID, name: "æˆ‘çš„åº—é“º", join_code: "-" };

const fmtMoney = (n) => (Number(n || 0)).toFixed(2);
const fmtDateTime = (iso) => new Date(iso).toLocaleString("zh-CN", { hour12:false });
function showToast(msg) {
  const textEl = document.getElementById("toastText");
  const toastEl = document.getElementById("toast");
  if (!textEl || !toastEl || !window.bootstrap || !bootstrap.Toast) {
    console.log("Toast:", msg);
    return;
  }
  textEl.textContent = msg;
  new bootstrap.Toast(toastEl, { delay: 1600 }).show();
}

// âœ… å…œåº•ï¼šè„šæœ¬å‡ºé”™æ—¶ç»™å‡ºæç¤ºï¼Œé¿å…â€œæŒ‰é’®æ²¡ååº”ä½†çœ‹ä¸å‡ºæ¥å“ªé‡Œåäº†â€
window.addEventListener("error", (e) => {
  try {
    console.error(e?.error || e);
    alert("é¡µé¢è„šæœ¬å‡ºé”™ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯") + "\nè¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹æ›´å¤šä¿¡æ¯");
  } catch {}
});

function uuid() { return (crypto?.randomUUID ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2)+"_"+Date.now())); }

function staffById(id) { return DB.staff.find(s => s.id === id); }
function bookingById(id) { return DB.bookings.find(b => b.id === id); }
function invoiceById(id) { return DB.invoices.find(i => i.id === id); }

function dateToISO(dateStr, timeStr) { return new Date(dateStr + "T" + timeStr + ":00").toISOString(); }
function overlap(aStart, aEnd, bStart, bEnd) { return (aStart < bEnd) && (bStart < aEnd); }

function calcCommission(staff, amountBase) {
  if (!staff) return 0;
  const base = Number(amountBase || 0);
  if (staff.commission_type === "percent") return base * (Number(staff.commission_value || 0) / 100);
  return Number(staff.commission_value || 0);
}
function autoStatus(total, paid, depositDue) {
  total = Number(total||0);
  paid = Number(paid||0);
  depositDue = Math.max(0, Number(depositDue||0));
  if (paid <= 0.00001) return "UNPAID";
  if (paid + 0.00001 < depositDue) return "DEPOSIT";
  if (paid + 0.00001 < total) return "PARTIAL";
  return "PAID";
}
function statusLabel(st) {
  if (st === "VOID") return "ä½œåºŸ";
  if (st === "UNPAID") return "æœªæ”¶";
  if (st === "DEPOSIT") return "å·²æ”¶å®šé‡‘";
  if (st === "PARTIAL") return "éƒ¨åˆ†æ”¶";
  if (st === "PAID") return "å·²ç»“æ¸…";
  return st;
}
function invoiceBadge(inv) {
  const st = inv.statusFinal || inv.status_final || "UNPAID";
  if (st === "VOID") return { text: "ä½œåºŸ", cls: "bg-secondary text-white" };
  if (st === "PAID") return { text: "å·²ç»“æ¸…", cls: "bg-success text-white" };
  if (st === "PARTIAL") return { text: "éƒ¨åˆ†æ”¶", cls: "bg-primary text-white" };
  if (st === "DEPOSIT") return { text: "å·²æ”¶å®šé‡‘", cls: "bg-info text-dark" };
  return { text: "æœªæ”¶", cls: "bg-warning text-dark" };
}

/********************
 * Cloud: shop meta
 ********************/
async function loadShopMeta() {
  try {
    const { data, error } = await sb.from("shops").select("*").eq("id", SHOP_ID).maybeSingle();
    if (error) throw error;
    if (data) {
      currentShop = data;
      document.getElementById("appTitle").textContent = `ğŸ’„ ${data.name}ï¼ˆäº‘åŒæ­¥Â·å…ç™»å½•ï¼‰`;
    } else {
      currentShop = { id: SHOP_ID, name: "æˆ‘çš„åº—é“º", join_code: "-" };
    }
  } catch {
    currentShop = { id: SHOP_ID, name: "æˆ‘çš„åº—é“º", join_code: "-" };
  }
}

/********************
 * Cloud sync: load all
 ********************/
async function loadAll() {
  // staff
  const { data: staff, error: e1 } = await sb
    .from("staff")
    .select("*")
    .eq("shop_id", currentShop.id)
    .order("created_at", { ascending: true });
  if (e1) throw e1;

  // services
  const { data: svcs, error: e2 } = await sb
    .from("staff_services")
    .select("*")
    .eq("shop_id", currentShop.id)
    .order("created_at", { ascending: true });
  if (e2) throw e2;

  // bookings
  const { data: bookings, error: e3 } = await sb
    .from("bookings")
    .select("*")
    .eq("shop_id", currentShop.id)
    .order("start_iso", { ascending: true });
  if (e3) throw e3;

  // invoices
  const { data: invoices, error: e4 } = await sb
    .from("invoices")
    .select("*")
    .eq("shop_id", currentShop.id)
    .order("created_at", { ascending: false });
  if (e4) throw e4;

  // stitch services into staff
  const staffMap = new Map((staff||[]).map(s => [s.id, { ...s, services: [] }]));
  (svcs||[]).forEach(svc => {
    const st = staffMap.get(svc.staff_id);
    if (st) st.services.push({ id: svc.id, name: svc.name, price: Number(svc.price||0) });
  });

  DB.staff = Array.from(staffMap.values());
  DB.bookings = (bookings||[]).map(b => ({
    ...b,
    servicePrice: Number(b.service_price||0),
    startISO: b.start_iso,
    endISO: b.end_iso,
    custName: b.cust_name,
    custPhone: b.cust_phone,
    staffId: b.staff_id,
    serviceId: b.service_id,
    serviceName: b.service_name,
    startTime: b.start_time,
    endTime: b.end_time,
    note: b.note,
    status: b.status,
    date: b.date
  }));
  DB.invoices = (invoices||[]).map(inv => ({
    ...inv,
    bookingId: inv.booking_id,
    amountTotal: Number(inv.amount_total||0),
    depositDue: Number(inv.deposit_due||DEFAULT_DEPOSIT),
    amountPaid: Number(inv.amount_paid||0),
    payMethod: inv.pay_method,
    statusManual: inv.status_manual,
    statusFinal: inv.status_final,
    note: inv.note,
    history: Array.isArray(inv.history) ? inv.history : (inv.history || [])
  }));

  refreshAll();
}

/********************
 * CRUD: Staff & Services
 ********************/
async function upsertStaff(st) {
  const payload = {
    id: st.id || uuid(),
    shop_id: currentShop.id,
    name: st.name,
    commission_type: st.commissionType,
    commission_value: st.commissionValue,
    updated_at: new Date().toISOString()
  };
  if (!st.id) payload.created_at = new Date().toISOString();

  const { error } = await sb.from("staff").upsert(payload);
  if (error) throw error;
  return payload.id;
}
async function deleteStaffCloud(staffId) {
  const { error } = await sb.from("staff").delete().eq("id", staffId).eq("shop_id", currentShop.id);
  if (error) throw error;
}
async function upsertServiceCloud(staffId, svc) {
  const payload = {
    id: svc.id || uuid(),
    shop_id: currentShop.id,
    staff_id: staffId,
    name: svc.name,
    price: svc.price,
    updated_at: new Date().toISOString()
  };
  if (!svc.id) payload.created_at = new Date().toISOString();

  const { error } = await sb.from("staff_services").upsert(payload);
  if (error) throw error;
  return payload.id;
}
async function deleteServiceCloud(serviceId) {
  const { error } = await sb.from("staff_services").delete().eq("id", serviceId).eq("shop_id", currentShop.id);
  if (error) throw error;
}

/********************
 * CRUD: Booking
 ********************/
async function upsertBookingCloud(b) {
  const payload = {
    id: b.id || uuid(),
    shop_id: currentShop.id,
    cust_name: b.custName,
    cust_phone: b.custPhone || null,
    staff_id: b.staffId,
    service_id: b.serviceId,
    service_name: b.serviceName,
    service_price: b.servicePrice,
    date: b.date,
    start_time: b.startTime,
    end_time: b.endTime,
    start_iso: b.startISO,
    end_iso: b.endISO,
    status: b.status,
    note: b.note || null,
    updated_at: new Date().toISOString()
  };
  if (!b.id) payload.created_at = new Date().toISOString();

  const { error } = await sb.from("bookings").upsert(payload);
  if (error) throw error;
  return payload.id;
}
async function deleteBookingCloud(id) {
  const { error } = await sb.from("bookings").delete().eq("id", id).eq("shop_id", currentShop.id);
  if (error) throw error;
}

/********************
 * CRUD: Invoice
 ********************/
async function upsertInvoiceCloud(inv) {
  const payload = {
    id: inv.id || uuid(),
    shop_id: currentShop.id,
    booking_id: inv.bookingId || null,
    amount_total: inv.amountTotal,
    deposit_due: inv.depositDue,
    amount_paid: inv.amountPaid,
    pay_method: inv.payMethod || null,
    note: inv.note || null,
    status_manual: inv.statusManual || "AUTO",
    status_final: inv.statusFinal || "UNPAID",
    history: inv.history || [],
    updated_at: new Date().toISOString()
  };
  if (!inv.id) payload.created_at = new Date().toISOString();

  const { error } = await sb.from("invoices").upsert(payload);
  if (error) throw error;
  return payload.id;
}
async function deleteInvoiceCloud(id) {
  const { error } = await sb.from("invoices").delete().eq("id", id).eq("shop_id", currentShop.id);
  if (error) throw error;
}

/********************
 * Routing
 ********************/
function showPage(name) {
  // Some pages may be removed in customized builds; guard nulls to avoid crashes.
  ["Calendar","Staff","Reports"].forEach(p => {
    const el = document.getElementById("page" + p);
    if (!el) return;
    el.classList.toggle("d-none", p !== name);
  });
  if (name === "Staff") {
    renderStaff();
    renderServiceListForCurrentStaff();
  }
  document.querySelectorAll(".bottom-nav .btn").forEach(btn => {
    const active = btn.dataset.page === name;
    btn.classList.toggle("btn-primary", active);
    btn.classList.toggle("btn-outline-primary", !active);
  });
}
document.querySelectorAll(".bottom-nav .btn").forEach(btn => {
  btn.addEventListener("click", () => showPage(btn.dataset.page));
});

/********************
 * Calendar
 ********************/
let calendar;
let selectedCalStaffId = ""; // "" = å…¨éƒ¨

function invoiceForBooking(bookingId) {
  return DB.invoices.find(i => (i.bookingId || i.booking_id) === bookingId) || null;
}

function computePayStateForBooking(bookingId) {
  const inv = invoiceForBooking(bookingId);
  if (!inv) return { has:false, statusFinal:"NONE", depositPaid:false, fullyPaid:false, color:null };
  const st = (inv.statusFinal || inv.status_final || "UNPAID");
  const total = Number(inv.amountTotal ?? inv.amount_total ?? 0);
  const depositDue = Math.max(0, Math.min(Number(inv.depositDue ?? inv.deposit_due ?? DEFAULT_DEPOSIT), total));
  const paid = Number(inv.amountPaid ?? inv.amount_paid ?? 0);
  const depositPaid = paid + 1e-6 >= depositDue && depositDue > 0;
  const fullyPaid = paid + 1e-6 >= total && total > 0;
  let color = null;
  if (fullyPaid) color = "#198754"; // ç»¿
  else if (depositPaid && !fullyPaid) color = "#dc3545"; // çº¢
  return { has:true, statusFinal:st, depositPaid, fullyPaid, color, total, depositDue, paid };
}

async function ensureInvoiceForBooking(booking, allowUpdateTotals=true) {
  if (!booking?.id) return;
  let inv = invoiceForBooking(booking.id);
  const total = Number(booking.servicePrice || 0);
  const depositDue = Math.min(DEFAULT_DEPOSIT, total);
  if (!inv) {
    const record = {
      id: uuid(),
      bookingId: booking.id,
      amountTotal: total,
      depositDue: depositDue,
      amountPaid: 0,
      payMethod: "å¾®ä¿¡",
      note: "",
      statusManual: "AUTO",
      statusFinal: autoStatus(total, 0, depositDue),
      history: [{
        at: new Date().toISOString(),
        action: "AUTO_CREATE_FROM_BOOKING",
        amountTotal: total,
        depositDue: depositDue,
        amountPaid: 0,
        payMethod: "å¾®ä¿¡",
        statusManual: "AUTO",
        statusFinal: autoStatus(total, 0, depositDue),
        statusFinalLabel: statusLabel(autoStatus(total, 0, depositDue)),
        note: ""
      }]
    };
    await upsertInvoiceCloud(record);
    return;
  }
  // å¦‚æœè¿˜æ²¡æ”¶è¿‡é’±ï¼Œå¹¶ä¸”å…è®¸åŒæ­¥é‡‘é¢ï¼Œåˆ™è·Ÿéšé¢„çº¦é¡¹ç›®é‡‘é¢
  const paid = Number(inv.amountPaid ?? inv.amount_paid ?? 0);
  if (allowUpdateTotals && paid <= 1e-6 && (inv.statusManual || inv.status_manual || "AUTO") === "AUTO") {
    const newTotal = total;
    const newDeposit = Math.min(DEFAULT_DEPOSIT, newTotal);
    const stAuto = autoStatus(newTotal, 0, newDeposit);
    const record = {
      id: inv.id,
      bookingId: booking.id,
      amountTotal: newTotal,
      depositDue: newDeposit,
      amountPaid: 0,
      payMethod: inv.payMethod || inv.pay_method || "å¾®ä¿¡",
      note: inv.note || "",
      statusManual: "AUTO",
      statusFinal: stAuto,
      history: (Array.isArray(inv.history) ? inv.history : []).concat([{
        at: new Date().toISOString(),
        action: "SYNC_FROM_BOOKING",
        amountTotal: newTotal,
        depositDue: newDeposit,
        amountPaid: 0,
        payMethod: inv.payMethod || inv.pay_method || "å¾®ä¿¡",
        statusManual: "AUTO",
        statusFinal: stAuto,
        statusFinalLabel: statusLabel(stAuto),
        note: inv.note || ""
      }])
    };
    await upsertInvoiceCloud(record);
  }
}

async function settleBookingPayment(bookingId, mode) {
  const b = bookingById(bookingId);
  if (!b) return;
  await ensureInvoiceForBooking(b, false);
  // é‡æ–°å–ä¸€æ¬¡ï¼ˆç¡®ä¿å­˜åœ¨ï¼‰
  const inv = invoiceForBooking(bookingId);
  if (!inv) return;
  const total = Number(inv.amountTotal ?? inv.amount_total ?? 0);
  const depositDue = Math.max(0, Math.min(Number(inv.depositDue ?? inv.deposit_due ?? DEFAULT_DEPOSIT), total));
  let newPaid = 0;
  if (mode === "deposit") newPaid = depositDue;
  if (mode === "paidall") newPaid = total;
  const stAuto = autoStatus(total, newPaid, depositDue);
  const history = (Array.isArray(inv.history) ? inv.history : []).concat([{
    at: new Date().toISOString(),
    action: mode === "deposit" ? "CAL_QUICK_DEPOSIT" : "CAL_QUICK_PAIDALL",
    amountTotal: total,
    depositDue: depositDue,
    amountPaid: newPaid,
    payMethod: inv.payMethod || inv.pay_method || "å¾®ä¿¡",
    statusManual: "AUTO",
    statusFinal: stAuto,
    statusFinalLabel: statusLabel(stAuto),
    note: inv.note || ""
  }]);
  const record = {
    id: inv.id,
    bookingId: bookingId,
    amountTotal: total,
    depositDue: depositDue,
    amountPaid: newPaid,
    payMethod: inv.payMethod || inv.pay_method || "å¾®ä¿¡",
    note: inv.note || "",
    statusManual: "AUTO",
    statusFinal: stAuto,
    history: history
  };
  await upsertInvoiceCloud(record);
  await loadAll();
  showToast(mode === "deposit" ? "å·²æ”¶å®šé‡‘" : "å·²ç»“æ¸…å°¾æ¬¾");
}

// ç›´æ¥è®¾ç½®â€œå·²æ”¶â€é‡‘é¢ï¼ˆç”¨äºé¢„çº¦å•é‡Œå¡«å†™å®šé‡‘ï¼‰
async function setBookingPaidAmount(bookingId, amount) {
  const b = bookingById(bookingId);
  if (!b) return;
  await ensureInvoiceForBooking(b, true);
  const inv = invoiceForBooking(bookingId);
  if (!inv) return;

  const total = Number(b.servicePrice || 0);
  // bookingDepositPaid is the ACTUAL paid deposit; also sync depositDue to it
  const newDeposit = Math.max(0, Math.min(Number(amount || 0), total));
  const newPaid = newDeposit;

  // keep both camelCase and snake_case fields to match existing code paths
  inv.depositDue = newDeposit;
  inv.deposit_due = newDeposit;
  inv.amountPaid = newPaid;
  inv.amount_paid = newPaid;

  inv.statusFinal = autoStatus(total, newPaid, newDeposit);
  inv.status_final = inv.statusFinal;
  inv.statusFinalLabel = statusLabel(inv.statusFinal);

  await upsertInvoiceCloud(inv);
}



const __bookingModalEl = document.getElementById("bookingModal");
const bookingModal = __bookingModalEl ? new bootstrap.Modal(__bookingModalEl) : null;
const __invoiceModalEl = $("invoiceModal");
const invoiceModal = __invoiceModalEl ? new bootstrap.Modal(__invoiceModalEl) : null;
const __shopModalEl = document.getElementById("shopModal");
const shopModal = __shopModalEl ? new bootstrap.Modal(__shopModalEl) : null;

function bookingToEvent(b) {
  const st = staffById(b.staffId);
  const pay = computePayStateForBooking(b.id);
  const color = pay.color;
  return {
    id: b.id,
    title: b.custName,
    start: b.startISO,
    end: b.endISO,
    backgroundColor: color || undefined,
    borderColor: color || undefined,
    extendedProps: {
      custName: b.custName,
      serviceName: b.serviceName || "",
      staffName: st ? st.name : "å‘˜å·¥å·²åˆ ",
      status: b.status || "",
      payDeposit: pay.depositPaid,
      payFully: pay.fullyPaid
    }
  };
}
function refreshCalendar() {
  if (!calendar) return;
  calendar.removeAllEvents();
  DB.bookings
    .filter(b => !selectedCalStaffId || b.staffId === selectedCalStaffId)
    .forEach(b => calendar.addEvent(bookingToEvent(b)));
}
function populateCalStaffFilter() {
  const sel = document.getElementById("calStaffFilter");
  if (!sel) return;
  const cur = selectedCalStaffId;
  sel.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "å…¨éƒ¨";
  sel.appendChild(optAll);
  DB.staff.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = s.name;
    sel.appendChild(opt);
  });
  sel.value = cur;
}

document.addEventListener("change", (e) => {
  if (e.target && e.target.id === "calStaffFilter") {
    selectedCalStaffId = e.target.value || "";
    refreshCalendar();
  }
});

function fillStaffSelect(selectEl, selectedId=null) {
  selectEl.innerHTML = "";
  DB.staff.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${s.name}ï¼ˆ${s.commission_type === "percent" ? s.commission_value+"%": fmtMoney(s.commission_value)+"å…ƒ/å•"}ï¼‰`;
    if (selectedId && selectedId === s.id) opt.selected = true;
    selectEl.appendChild(opt);
  });
  if (!DB.staff.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "è¯·å…ˆåœ¨ã€åŒ–å¦†å¸ˆã€‘é‡Œæ–°å¢";
    selectEl.appendChild(opt);
  }
}
function fillServiceSelectByStaff(serviceSelectEl, staffId, selectedServiceId=null) {
  serviceSelectEl.innerHTML = "";
  const st = staffById(staffId);
  const svcs = st?.services || [];
  if (!svcs.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "è¯¥åŒ–å¦†å¸ˆæš‚æ— é¡¹ç›®ï¼ˆå»åŒ–å¦†å¸ˆé¡µæ·»åŠ ï¼‰";
    serviceSelectEl.appendChild(opt);
    return;
  }
  svcs.forEach(svc => {
    const opt = document.createElement("option");
    opt.value = svc.id;
    opt.textContent = `${svc.name}`;
    if (selectedServiceId && selectedServiceId === svc.id) opt.selected = true;
    serviceSelectEl.appendChild(opt);
  });
}
on("staffSelect","change", () => {
  const staffId = document.getElementById("staffSelect").value;
  fillServiceSelectByStaff(document.getElementById("serviceSelect"), staffId);
});

function openNewBooking(prefill={}) {
  document.getElementById("bookingId").value = "";
  document.getElementById("custName").value = prefill.custName || "";
  document.getElementById("custPhone").value = prefill.custPhone || "";
  document.getElementById("bookDate").value = prefill.date || new Date().toISOString().slice(0,10);
  document.getElementById("startTime").value = prefill.startTime || "09:00";
  document.getElementById("endTime").value = prefill.endTime || "11:00";

  fillStaffSelect(document.getElementById("staffSelect"), prefill.staffId || (DB.staff[0]?.id ?? null));
  const staffId = document.getElementById("staffSelect").value;
  fillServiceSelectByStaff(document.getElementById("serviceSelect"), staffId, prefill.serviceId || null);

  document.getElementById("bookingStatus").value = prefill.status || "å·²é¢„çº¦";
  document.getElementById("bookingNote").value = prefill.note || "";

  document.getElementById("btnDeleteBooking").classList.add("d-none");
  document.getElementById("conflictAlert").classList.add("d-none");
  updateBookingPayBar("");
  bookingModal && bookingModal.show();
}
function openEditBooking(id) {
  const b = bookingById(id);
  if (!b) return;
  document.getElementById("bookingId").value = b.id;
  document.getElementById("custName").value = b.custName;
  document.getElementById("custPhone").value = b.custPhone || "";
  document.getElementById("bookDate").value = b.date;
  document.getElementById("startTime").value = b.startTime;
  document.getElementById("endTime").value = b.endTime;

  fillStaffSelect(document.getElementById("staffSelect"), b.staffId);
  fillServiceSelectByStaff(document.getElementById("serviceSelect"), b.staffId, b.serviceId || null);

  document.getElementById("bookingStatus").value = b.status;
  document.getElementById("bookingNote").value = b.note || "";

  document.getElementById("btnDeleteBooking").classList.remove("d-none");
  document.getElementById("conflictAlert").classList.add("d-none");
  updateBookingPayBar(id);
  bookingModal && bookingModal.show();
}

function updateBookingPayBar(bookingId) {
  const infoEl = document.getElementById("bookingPayInfo");
  const depInput = document.getElementById("bookingDepositPaid");
  const btnAll = document.getElementById("btnBookingPaidAll");

  // æ–°å»ºé¢„çº¦ï¼šå…è®¸ç›´æ¥å¡«å†™å®šé‡‘ï¼Œä¿å­˜æ—¶ç”Ÿæ•ˆ
  if (!bookingId) {
    infoEl.textContent = "å®šé‡‘/å°¾æ¬¾ï¼šå¯ç›´æ¥å¡«å†™å®šé‡‘é‡‘é¢ï¼Œä¿å­˜åè‡ªåŠ¨ç”Ÿæˆè´¦å•";
    if (depInput) depInput.disabled = false;
    if (btnAll) btnAll.disabled = true;
    return;
  }

  const pay = computePayStateForBooking(bookingId);
  if (!pay.has) {
    infoEl.textContent = "å®šé‡‘/å°¾æ¬¾ï¼šæœªç”Ÿæˆè´¦å•ï¼ˆä¿å­˜åè‡ªåŠ¨ç”Ÿæˆï¼‰";
    if (depInput) depInput.disabled = false;
    if (btnAll) btnAll.disabled = false;
    return;
  }

  const total = pay.total ?? 0;
  const paid = pay.paid ?? 0;
  const depTxt = pay.depositPaid ? "å®šé‡‘å·²æ”¶" : "å®šé‡‘æœªæ”¶";
  const balTxt = pay.fullyPaid ? "å°¾æ¬¾å·²ç»“æ¸…" : (pay.depositPaid ? "å°¾æ¬¾æœªç»“æ¸…" : "å°¾æ¬¾æœªå¼€å§‹");
  infoEl.textContent = `${depTxt} / ${balTxt}ï¼ˆåº”æ”¶${fmtMoney(total)}ï¼Œå·²æ”¶${fmtMoney(paid)}ï¼‰`;

  if (depInput) {
    depInput.disabled = pay.fullyPaid;
    depInput.value = (pay.depositDue ?? 0) ? String(pay.depositDue) : "";
  }
  if (btnAll) btnAll.disabled = pay.fullyPaid;
}

on("btnBookingPaidAll","click", async () => {
  const bookingId = document.getElementById("bookingId").value;
  if (!bookingId) return alert("è¯·å…ˆä¿å­˜é¢„çº¦ï¼Œå†ç»“æ¸…å°¾æ¬¾");
  await settleBookingPayment(bookingId, "paidall");
  updateBookingPayBar(bookingId);
});

// é¢„çº¦å•é‡Œç›´æ¥å¡«å†™å®šé‡‘é‡‘é¢ï¼ˆä¿å­˜åè‡ªåŠ¨ç”Ÿæ•ˆï¼›å·²ä¿å­˜çš„é¢„çº¦å¯ç›´æ¥æ”¹ï¼‰
// é¢„çº¦å•é‡Œç›´æ¥å¡«å†™å®šé‡‘é‡‘é¢ï¼šè¾“å…¥åè‡ªåŠ¨å†™å…¥ï¼ˆå·²ä¿å­˜çš„é¢„çº¦ï¼‰ï¼›æ–°å»ºé¢„çº¦ä¼šåœ¨â€œä¿å­˜â€æ—¶å†™å…¥
let __depTimer = null;
on("bookingDepositPaid","input", () => {
  const bookingId = document.getElementById("bookingId")?.value || "";
  const v = Number(document.getElementById("bookingDepositPaid")?.value || 0);
  const infoEl = document.getElementById("bookingPayInfo");
  if (infoEl) {
    if (!bookingId) {
      infoEl.textContent = v > 0
        ? `å®šé‡‘ï¼ˆé¢„å¡«ï¼‰ï¼š${fmtMoney(v)}ï¼ˆä¿å­˜åç”Ÿæ•ˆï¼‰`
        : "å®šé‡‘/å°¾æ¬¾ï¼šå¯ç›´æ¥å¡«å†™å®šé‡‘é‡‘é¢ï¼Œä¿å­˜åè‡ªåŠ¨ç”Ÿæˆè´¦å•";
    } else {
      infoEl.textContent = v > 0
        ? `å®šé‡‘å·²æ”¶ / å°¾æ¬¾æœªç»“æ¸…ï¼ˆå·²æ”¶${fmtMoney(v)}ï¼‰`
        : "å®šé‡‘æœªæ”¶ / å°¾æ¬¾æœªå¼€å§‹";
    }
  }

  // æ–°å»ºé¢„çº¦ï¼šä»…åšå±•ç¤ºï¼ŒçœŸæ­£å†™å…¥åœ¨â€œä¿å­˜â€æ—¶å¤„ç†
  if (!bookingId) return;

  clearTimeout(__depTimer);
  __depTimer = setTimeout(async () => {
    try {
      await setBookingPaidAmount(bookingId, v);
      await loadAll();
      updateBookingPayBar(bookingId);
      refreshCalendar();
    } catch (e) {
      console.error(e);
      alert("æ›´æ–°å®šé‡‘å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
    }
  }, 500);
});

function validateBooking(payload) {
  const errs = [];
  if (!payload.custName.trim()) errs.push("å®¢æˆ·å§“åå¿…å¡«");
  if (!payload.staffId) errs.push("åŒ–å¦†å¸ˆå¿…é€‰");
  if (!payload.serviceId) errs.push("é¡¹ç›®å¿…é€‰");
  if (!payload.date || !payload.startTime || !payload.endTime) errs.push("æ—¥æœŸ/æ—¶é—´å¿…å¡«");
  const a = dateToISO(payload.date, payload.startTime);
  const b = dateToISO(payload.date, payload.endTime);
  if (a >= b) errs.push("ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´");

  const conflict = DB.bookings.some(x => {
    if (payload.id && x.id === payload.id) return false;
    if (x.staffId !== payload.staffId) return false;
    if (x.status === "å·²å–æ¶ˆ") return false;
    return overlap(a, b, x.startISO, x.endISO);
  });
  return { errs, conflict, startISO: a, endISO: b };
}

on("btnSaveBooking","click", async () => {
  try {
    const id = document.getElementById("bookingId").value || null;
    const payload = {
      id,
      custName: document.getElementById("custName").value,
      custPhone: document.getElementById("custPhone").value,
      staffId: document.getElementById("staffSelect").value,
      serviceId: document.getElementById("serviceSelect").value,
      date: document.getElementById("bookDate").value,
      startTime: document.getElementById("startTime").value,
      endTime: document.getElementById("endTime").value,
      status: document.getElementById("bookingStatus").value,
      note: document.getElementById("bookingNote").value
    };

    const { errs, conflict, startISO, endISO } = validateBooking(payload);
    const alertBox = document.getElementById("conflictAlert");

    if (errs.length) { alertBox.textContent = errs.join("ï¼›"); alertBox.classList.remove("d-none"); return; }
    if (conflict) { alertBox.textContent = "é¢„çº¦å†²çªï¼šè¯¥åŒ–å¦†å¸ˆåœ¨æ­¤æ—¶é—´æ®µå·²æœ‰é¢„çº¦ã€‚"; alertBox.classList.remove("d-none"); return; }
    alertBox.classList.add("d-none");

    const st = staffById(payload.staffId);
    const svc = st?.services?.find(x => x.id === payload.serviceId);
    if (!svc) return alert("é¡¹ç›®æ— æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©");

    const record = {
      id: payload.id || uuid(),
      custName: payload.custName.trim(),
      custPhone: payload.custPhone.trim(),
      staffId: payload.staffId,
      serviceId: payload.serviceId,
      serviceName: svc.name,
      servicePrice: Number(svc.price || 0),
      date: payload.date,
      startTime: payload.startTime,
      endTime: payload.endTime,
      startISO,
      endISO,
      status: payload.status,
      note: payload.note.trim()
    };

    await upsertBookingCloud(record);

    // âœ… Keep local cache in sync immediately (new bookings are not in DB until loadAll)
    const _idx = DB.bookings.findIndex(x => x.id === record.id);
    if (_idx >= 0) DB.bookings[_idx] = record; else DB.bookings.push(record);

    // Ensure invoice exists (for calendar/pay-state)
    await ensureInvoiceForBooking(record, true);

    // âœ… If user filled deposit while creating a NEW booking, bookingById() would be null.
    // So we update invoice directly using the saved booking record.
    const __depPaid = Number(document.getElementById("bookingDepositPaid")?.value || 0);
    if (__depPaid > 0) {
      const total = Number(record.servicePrice || 0);
      const dep = Math.max(0, Math.min(__depPaid, total));
      const st = autoStatus(total, dep, dep);
      const invRecord = invoiceForBooking(record.id) || {
        id: uuid(),
        bookingId: record.id,
        amountTotal: total,
        depositDue: dep,
        amountPaid: dep,
        payMethod: "å¾®ä¿¡",
        note: "",
        statusManual: "AUTO",
        statusFinal: st,
        statusFinalLabel: statusLabel(st),
        history: [{
          at: new Date().toISOString(),
          action: "DEPOSIT_SET_FROM_BOOKING",
          amountTotal: total,
          depositDue: dep,
          amountPaid: dep,
          payMethod: "å¾®ä¿¡",
          statusManual: "AUTO",
          statusFinal: st,
          statusFinalLabel: statusLabel(st),
        }]
      };

      // keep both camelCase & snake_case for compatibility
      invRecord.depositDue = dep; invRecord.deposit_due = dep;
      invRecord.amountPaid = dep; invRecord.amount_paid = dep;
      invRecord.amountTotal = total; invRecord.amount_total = total;
      invRecord.statusFinal = st; invRecord.status_final = st;

      await upsertInvoiceCloud(invRecord);
    }

    await loadAll();
    bookingModal && bookingModal.hide();
    showToast(id ? "é¢„çº¦å·²æ›´æ–°" : "é¢„çº¦å·²æ–°å¢");
  } catch (e) {
    console.error(e);
    alert("ä¿å­˜å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
  }
});

on("btnDeleteBooking","click", async () => {
  const id = document.getElementById("bookingId").value;
  if (!id) return;
  if (!confirm("ç¡®å®šåˆ é™¤è¯¥é¢„çº¦ï¼Ÿï¼ˆè´¦å•ä¸ä¼šè‡ªåŠ¨åˆ é™¤ï¼‰")) return;
  try {
    await deleteBookingCloud(id);
    await loadAll();
    bookingModal && bookingModal.hide();
    showToast("é¢„çº¦å·²åˆ é™¤");
  } catch (e) {
    console.error(e);
    alert("åˆ é™¤å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
  }
});

/********************
 * Staff Page render + actions
 ********************/
function renderStaff() {
  const staffCountEl = document.getElementById("staffCount");
  if (staffCountEl) staffCountEl.textContent = `å…± ${DB.staff.length} ä½`;
  const box = document.getElementById("staffCards");
  if (!box) return;
  box.innerHTML = "";

  if (!DB.staff.length) { box.innerHTML = `<div class="small-muted">æš‚æ— åŒ–å¦†å¸ˆï¼Œè¯·å…ˆæ–°å¢ã€‚</div>`; return; }

  DB.staff.forEach(s => {
    const rule = s.commission_type === "percent" ? `${s.commission_value}%` : `${fmtMoney(s.commission_value)} å…ƒ/å•`;
    const div = document.createElement("div");
    div.className = "card border-0 shadow-sm";
    div.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-semibold">${s.name}</div>
            <div class="small-muted">ææˆï¼š<span class="mono">${rule}</span></div>
            <div class="small-muted">é¡¹ç›®æ•°ï¼š<span class="mono">${(s.services||[]).length}</span></div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" data-act="edit" data-id="${s.id}">ç¼–è¾‘</button>
            <button class="btn btn-outline-danger btn-sm" data-act="del" data-id="${s.id}">åˆ é™¤</button>
          </div>
        </div>
      </div>
    `;
    box.appendChild(div);
  });

  box.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", async () => {
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if (act === "edit") openEditStaff(id);
      if (act === "del") {
        if (!confirm("ç¡®å®šåˆ é™¤è¯¥åŒ–å¦†å¸ˆï¼Ÿå†å²å•æ®ä¼šæ˜¾ç¤ºâ€œå‘˜å·¥å·²åˆ é™¤â€ã€‚")) return;
        try {
          await deleteStaffCloud(id);
          await loadAll();
          showToast("å·²åˆ é™¤");
        } catch (e) {
          console.error(e);
          alert("åˆ é™¤å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
        }
      }
    });
  });
}

function openEditStaff(id) {
  const s = staffById(id);
  if (!s) return;
  document.getElementById("staffId").value = s.id;
  document.getElementById("staffName").value = s.name;
  document.getElementById("commissionType").value = s.commission_type;
  document.getElementById("commissionValue").value = s.commission_value;
  renderServiceListForCurrentStaff();
}
function currentStaffId() {
  const el = document.getElementById("staffId");
  return el ? (el.value || "") : "";
}

function renderServiceListForCurrentStaff() {
  const staffId = currentStaffId();
  const listEl = document.getElementById("serviceList");
  if (!listEl) return;
  listEl.innerHTML = "";

  if (!staffId) { listEl.innerHTML = `<div class="small-muted">å…ˆä¿å­˜/é€‰æ‹©åŒ–å¦†å¸ˆï¼Œå†æ·»åŠ é¡¹ç›®ã€‚</div>`; return; }
  const st = staffById(staffId);
  if (!st) return;

  const svcs = st.services || [];
  if (!svcs.length) { listEl.innerHTML = `<div class="small-muted">æš‚æ— é¡¹ç›®ï¼Œä½¿ç”¨ä¸Šæ–¹è¾“å…¥æ¡†æ·»åŠ ã€‚</div>`; return; }

  svcs.forEach(svc => {
    const div = document.createElement("div");
    div.className = "svc-item";
    div.innerHTML = `
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="fw-semibold">${svc.name}</div>
          <div class="small-muted">é‡‘é¢ï¼š<span class="mono">${fmtMoney(svc.price)}</span></div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" data-act="editSvc" data-id="${svc.id}">æ”¹</button>
          <button class="btn btn-outline-danger btn-sm" data-act="delSvc" data-id="${svc.id}">åˆ </button>
        </div>
      </div>
    `;
    listEl.appendChild(div);
  });

  listEl.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", async () => {
      const act = btn.dataset.act;
      const svcId = btn.dataset.id;
      const st = staffById(currentStaffId());
      if (!st) return;

      if (act === "delSvc") {
        if (!confirm("ç¡®å®šåˆ é™¤è¯¥é¡¹ç›®ï¼Ÿå†å²é¢„çº¦ä¿ç•™é¡¹ç›®åç§°/ä»·æ ¼å¿«ç…§ã€‚")) return;
        try {
          await deleteServiceCloud(svcId);
          await loadAll();
          renderServiceListForCurrentStaff();
          showToast("é¡¹ç›®å·²åˆ é™¤");
        } catch (e) {
          console.error(e);
          alert("åˆ é™¤å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
        }
      }

      if (act === "editSvc") {
        const svc = (st.services || []).find(x => x.id === svcId);
        if (!svc) return;
        const newName = prompt("é¡¹ç›®åç§°ï¼š", svc.name);
        if (newName === null) return;
        const newPriceStr = prompt("é‡‘é¢ï¼š", String(svc.price ?? 0));
        if (newPriceStr === null) return;
        const newPrice = Number(newPriceStr);
        if (!newName.trim()) return alert("åç§°ä¸èƒ½ä¸ºç©º");
        if (Number.isNaN(newPrice) || newPrice < 0) return alert("é‡‘é¢å¿…é¡»>=0");
        try {
          await upsertServiceCloud(st.id, { id: svcId, name: newName.trim(), price: newPrice });
          await loadAll();
          renderServiceListForCurrentStaff();
          showToast("å·²ä¿®æ”¹");
        } catch (e) {
          console.error(e);
          alert("ä¿®æ”¹å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
        }
      }
    });
  });
}

on("btnSaveStaff","click", async () => {
  try {
    const id = document.getElementById("staffId").value || null;
    const name = document.getElementById("staffName").value.trim();
    const commissionType = document.getElementById("commissionType").value;
    const commissionValue = Number(document.getElementById("commissionValue").value);

    if (!name) return alert("å§“åå¿…å¡«");
    if (Number.isNaN(commissionValue) || commissionValue < 0) return alert("ææˆæ•°å€¼å¿…é¡»>=0");

    const staffId = await upsertStaff({ id, name, commissionType, commissionValue });
    document.getElementById("staffId").value = staffId;

    await loadAll();
    renderServiceListForCurrentStaff();
    showToast("å·²ä¿å­˜");
  } catch (e) {
    console.error(e);
    alert("ä¿å­˜å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
  }
});
on("btnClearStaff","click", () => {
  document.getElementById("staffId").value = "";
  document.getElementById("staffName").value = "";
  document.getElementById("commissionType").value = "percent";
  document.getElementById("commissionValue").value = "";
  document.getElementById("serviceList").innerHTML = `<div class="small-muted">å…ˆä¿å­˜/é€‰æ‹©åŒ–å¦†å¸ˆï¼Œå†æ·»åŠ é¡¹ç›®ã€‚</div>`;
});
on("btnAddService","click", async () => {
  const staffId = currentStaffId();
  if (!staffId) return alert("è¯·å…ˆä¿å­˜/é€‰æ‹©åŒ–å¦†å¸ˆ");
  const name = document.getElementById("svcName").value.trim();
  const price = Number(document.getElementById("svcPrice").value);
  if (!name) return alert("é¡¹ç›®åç§°å¿…å¡«");
  if (Number.isNaN(price) || price < 0) return alert("é‡‘é¢å¿…é¡»>=0");
  try {
    await upsertServiceCloud(staffId, { name, price });
    await loadAll();
    renderServiceListForCurrentStaff();
    document.getElementById("svcName").value = "";
    document.getElementById("svcPrice").value = "";
    showToast("é¡¹ç›®å·²æ·»åŠ ");
  } catch (e) {
    console.error(e);
    alert("æ·»åŠ å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
  }
});
on("btnClearServiceInput","click", () => {
  document.getElementById("svcName").value = "";
  document.getElementById("svcPrice").value = "";
});

/********************
 * Invoice UI
 ********************/
function setInvoiceAutoInfo(bookingId, isNewDraft) {
  const info = document.getElementById("invoiceAutoInfo");
  if (!bookingId) { info.textContent = "æœªç»‘å®šé¢„çº¦ï¼šå»ºè®®ç»‘å®šé¢„çº¦è‡ªåŠ¨å¸¦å‡ºé¡¹ç›®é‡‘é¢ã€‚"; return; }
  const b = bookingById(bookingId);
  if (!b) { info.textContent = "é¢„çº¦ä¸å­˜åœ¨ï¼ˆå¯èƒ½å·²åˆ é™¤ï¼‰"; return; }
  const st = staffById(b.staffId);
  info.innerHTML = `å·²ç»‘å®šï¼š<span class="mono">${b.date} ${b.startTime}-${b.endTime}</span>ï½œå®¢æˆ· <span class="mono">${b.custName}</span>ï½œé¡¹ç›® <span class="mono">${b.serviceName||""}</span>ï½œé‡‘é¢ <span class="mono">${fmtMoney(b.servicePrice||0)}</span>ï½œå‘˜å·¥ <span class="mono">${st?st.name:"å‘˜å·¥å·²åˆ "}</span>`;
  if (isNewDraft) {
    const curTotal = document.getElementById("amountTotal").value;
    if (curTotal === "" || Number(curTotal) === 0) document.getElementById("amountTotal").value = Number(b.servicePrice||0);
    const curDeposit = document.getElementById("depositDue").value;
    if (curDeposit === "" || Number(curDeposit) === 0) document.getElementById("depositDue").value = Math.min(DEFAULT_DEPOSIT, Number(b.servicePrice||0));
  }
}
function recalcInvoicePreview() {
  // Guard: invoice UI may be removed
  if (!document.getElementById("amountTotal")) return;
  const total = Number(document.getElementById("amountTotal").value || 0);
  let depositDue = Number(document.getElementById("depositDue").value || 0);
  depositDue = Math.max(0, Math.min(depositDue, total));
  document.getElementById("depositDue").value = depositDue;
  const balanceDue = Math.max(0, total - depositDue);
  document.getElementById("balanceDue").value = fmtMoney(balanceDue);

  const paid = Number(document.getElementById("amountPaid").value || 0);
  const stAuto = autoStatus(total, paid, depositDue);
  document.getElementById("statusHint").innerHTML = `è‡ªåŠ¨çŠ¶æ€ï¼š<span class="mono">${statusLabel(stAuto)}</span>`;
}
on("invoiceBooking","change", () => {
  setInvoiceAutoInfo(document.getElementById("invoiceBooking").value, true);
  recalcInvoicePreview();
});
["amountTotal","depositDue","amountPaid"].forEach(id => on(id,"input", recalcInvoicePreview));
on("btnQuickDeposit","click", () => {
  const total = Number(document.getElementById("amountTotal").value || 0);
  let depositDue = Number(document.getElementById("depositDue").value || 0);
  depositDue = Math.max(0, Math.min(depositDue, total));
  document.getElementById("amountPaid").value = depositDue;
  recalcInvoicePreview();
});
on("btnQuickPaidAll","click", () => {
  const total = Number(document.getElementById("amountTotal").value || 0);
  document.getElementById("amountPaid").value = total;
  recalcInvoicePreview();
});

function runReport() {
  const start = document.getElementById("repStart").value || "0000-01-01";
  const end = document.getElementById("repEnd").value || "9999-12-31";

  const filtered = DB.invoices.filter(inv => {
    const statusFinal = inv.statusFinal || inv.status_final;
    if (statusFinal === "VOID") return false;
    let d = inv.date || "";
    const bookingId = inv.bookingId || inv.booking_id;
    if (bookingId) {
      const b = bookingById(bookingId);
      d = b ? b.date : d;
    }
    return d >= start && d <= end;
  });

  let total = 0, paid = 0;
  const staffAgg = new Map();
  const openList = [];

  filtered.forEach(inv => {
    const amt = Number(inv.amountTotal || inv.amount_total || 0);
    const pd = Number(inv.amountPaid || inv.amount_paid || 0);
    const deposit = Math.max(0, Math.min(Number(inv.depositDue ?? inv.deposit_due ?? DEFAULT_DEPOSIT), amt));

    total += amt;
    paid += pd;
    let staff = null, staffId = "unknown", staffName = "æœªè¯†åˆ«";
    const bookingId = inv.bookingId || inv.booking_id;
    if (bookingId) {
      const b = bookingById(bookingId);
      if (b) {
        staff = staffById(b.staffId);
        staffId = b.staffId || "unknown";
        staffName = staff ? staff.name : "ï¼ˆå‘˜å·¥å·²åˆ é™¤ï¼‰";
      }
    }
    const commission = calcCommission(staff, amt);

    if (!staffAgg.has(staffId)) staffAgg.set(staffId, { name: staffName, count: 0, total: 0, commission: 0 });
    const rec = staffAgg.get(staffId);
    rec.count += 1;
    rec.total += amt;
    rec.commission += commission;

    const unpaidAll = Math.max(0, amt - pd);
    if (unpaidAll > 0.00001) {
      let d = inv.date || "";
      let cust = "ï¼ˆæœªç»‘å®šé¢„çº¦ï¼‰";
      let svc = "";
      if (bookingId) {
        const b = bookingById(bookingId);
        if (b) { d = b.date; cust = b.custName; svc = b.serviceName || ""; }
      }
      openList.push({ d, cust, svc, unpaidAll, id: inv.id });
    }
  });

  document.getElementById("repTotal").textContent = fmtMoney(total);
  document.getElementById("repPaid").textContent = fmtMoney(paid);
  document.getElementById("repUnpaid").textContent = fmtMoney(Math.max(0, total - paid));
  const staffBox = document.getElementById("repStaffCards");
  staffBox.innerHTML = "";
  const staffRows = [...staffAgg.values()].sort((a,b)=>b.total-a.total);
  if (!staffRows.length) staffBox.innerHTML = `<div class="small-muted">æš‚æ— æ•°æ®</div>`;
  else staffRows.forEach(r => {
    const div = document.createElement("div");
    div.className = "card shadow-sm";
    div.innerHTML = `
      <div class="card-body">
        <div class="fw-semibold">${r.name}</div>
        <div class="small-muted">å•æ•°ï¼š<span class="mono">${r.count}</span></div>
        <div class="small-muted">åº”æ”¶ï¼š<span class="mono">${fmtMoney(r.total)}</span></div>
        <div class="small-muted">ææˆï¼ˆæŒ‰åº”æ”¶ï¼‰ï¼š<span class="mono">${fmtMoney(r.commission)}</span></div>
      </div>
    `;
    staffBox.appendChild(div);
  });

  const openBox = document.getElementById("repOpenInvoices");
  openBox.innerHTML = "";
  if (!openList.length) openBox.innerHTML = `<div class="small-muted">æš‚æ— æœªç»“æ¸…è´¦å•</div>`;
  else {
    openList.sort((a,b)=>a.d.localeCompare(b.d)).forEach(x => {
      const div = document.createElement("div");
      div.className = "card shadow-sm";
      div.innerHTML = `
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div class="fw-semibold">${x.cust}</div>
            <div class="mono">æœªæ”¶ï¼š${fmtMoney(x.unpaidAll)}</div>
          </div>
          <div class="small-muted">${x.d} ${x.svc}</div>
                    <button class="btn btn-outline-primary btn-sm mt-2" data-id="${x.id}">æ‰“å¼€é¢„çº¦</button>
        </div>
      `;
      openBox.appendChild(div);
    });
    openBox.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        const inv = DB.invoices.find(i => i.id === btn.dataset.id);
        if (inv?.bookingId) {
          showPage("Calendar");
          openEditBooking(inv.bookingId);
        } else {
          alert("è¯¥è´¦å•æœªç»‘å®šé¢„çº¦ï¼Œæ— æ³•è·³è½¬");
        }
      });
    });
  }
}

/********************
 * Upcoming list
 ********************/
function renderUpcoming() {
  const __upListEl = document.getElementById("upcomingList");
  const __todayHintEl = document.getElementById("todayHint");
  // If upcoming UI is not present (e.g., module hidden), skip rendering to avoid runtime errors.
  if (!__upListEl && !__todayHintEl) return;
  const now = new Date();
  const today = now.toISOString().slice(0,10);
  if (__todayHintEl) __todayHintEl.textContent = `ä»Šå¤©ï¼š${today}`;

  const list = DB.bookings
    .filter(b => b.status !== "å·²å–æ¶ˆ")
    .sort((a,b) => (a.startISO||"").localeCompare(b.startISO||""))
    .filter(b => new Date(b.endISO) >= new Date(now.getTime() - 24*3600*1000))
    .slice(0, 10);

  const box = __upListEl;
  if (!box) return;
  box.innerHTML = "";

  if (!list.length) { box.innerHTML = `<div class="small-muted">æš‚æ— è¿‘æœŸé¢„çº¦</div>`; return; }

  list.forEach(b => {
    const st = staffById(b.staffId);
    const div = document.createElement("div");
    div.className = "card shadow-sm";
    div.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-semibold">${b.custName}</div>
            <div class="small-muted">${b.date} ${b.startTime}-${b.endTime}ï½œ${b.serviceName||""}ï½œ${st?st.name:"å‘˜å·¥å·²åˆ "}</div>
          </div>
          <span class="pill ${b.status==="å·²å®Œæˆ"?"bg-success text-white":"bg-primary text-white"}">${b.status}</span>
        </div>
        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-outline-primary flex-grow-1" data-act="edit" data-id="${b.id}">ç¼–è¾‘é¢„çº¦</button>
          <button class="btn btn-outline-secondary flex-grow-1" data-act="inv" data-id="${b.id}">åšè´¦å•</button>
        </div>
      </div>
    `;
    box.appendChild(div);
  });

  box.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if (act === "edit") openEditBooking(id);
    });
  });
}

/********************
 * Refresh all
 ********************/
function refreshAll() {
  renderStaff();
  renderServiceListForCurrentStaff();
  refreshCalendar();
  renderUpcoming();

  populateCalStaffFilter();

  fillStaffSelect(document.getElementById("staffSelect"), DB.staff[0]?.id ?? null);
  fillServiceSelectByStaff(document.getElementById("serviceSelect"), document.getElementById("staffSelect").value);

  const today = new Date().toISOString().slice(0,10);
  if (!document.getElementById("repStart").value) document.getElementById("repStart").value = today.slice(0,7) + "-01";
  if (!document.getElementById("repEnd").value) document.getElementById("repEnd").value = today;
}

/********************

* é¡µé¢é” Page Lock 2.0ï¼ˆäº‘ç«¯ç»Ÿä¸€ï¼‰
  ********************/

// âœ… å…ˆæ‹¿åˆ° DOM å…ƒç´ ï¼ˆå¦åˆ™ä¼š ReferenceError ç›´æ¥å´©ï¼‰
const lockModalEl = document.getElementById("lockModal");
const lockTipEl   = document.getElementById("lockTip");
const lockLabelEl = document.getElementById("lockLabel");
const lockPinEl   = document.getElementById("lockPin");
const lockErrEl   = document.getElementById("lockErr");
const lockOkBtn   = document.getElementById("lockOk");
const lockCancelBtn = document.getElementById("lockCancel");
const lockResetBtn  = document.getElementById("lockReset");

// If the modal markup is missing (e.g., customized HTML), gracefully disable page lock
// instead of crashing Bootstrap internals (which may access .isConnected on a null node).
const __pageLockUiReady = !!(lockModalEl && lockTipEl && lockLabelEl && lockPinEl && lockErrEl && lockOkBtn && lockCancelBtn && lockResetBtn);

// é¡µé¢é”è¿è¡Œæ€
let __pendingPage = null;

// ä¿å­˜åŸæ¥çš„ showPageï¼ˆè·¯ç”±å‡½æ•°ï¼‰ï¼Œåé¢æˆ‘ä»¬ä¼šé‡å†™ showPage æ¥åšæ‹¦æˆª
const __showPageOriginal = showPage;

function setUnlocked() { __pageUnlocked = true; }
function lockNow() { __pageUnlocked = false; }
function isUnlocked() { return __pageUnlocked === true; }

async function sha256(str) {
  const buf = new TextEncoder().encode(str);
  const hash = await crypto.subtle.digest("SHA-256", buf);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
}

async function getPageLockHash() {
  const { data, error } = await sb
    .from("shops")
    .select("page_lock_hash")
    .eq("id", currentShop.id)
    .maybeSingle();
  if (error) throw error;
  return data?.page_lock_hash || null;
}

async function setPageLock(pin) {
  const hash = await sha256(pin);
  const { error } = await sb
    .from("shops")
    .update({ page_lock_hash: hash })
    .eq("id", currentShop.id);
  if (error) throw error;
}

async function requirePageLock(pageName) {
  __pendingPage = pageName;

  if (!__pageLockUiReady) {
    // No UI available, fall back to allowing navigation.
    console.warn("Page lock UI missing; allowing navigation to", pageName);
    __showPageOriginal(pageName);
    return;
  }

  if (!lockModalEl || !window.bootstrap || !bootstrap.Modal) {
    console.warn("Page lock modal missing; allowing navigation to", pageName);
    __showPageOriginal(pageName);
    return;
  }

  const modal = bootstrap.Modal.getOrCreateInstance(lockModalEl);
  const hash = await getPageLockHash();

  lockErrEl.classList.add("d-none");
  lockErrEl.textContent = "";
  lockPinEl.value = "";

  if (!hash) {
    lockTipEl.textContent = "é¦–æ¬¡ä½¿ç”¨ï¼Œè¯·è®¾ç½®é¡µé¢é”å¯†ç ";
    lockLabelEl.textContent = "è®¾ç½®å¯†ç ï¼ˆ4~6 ä½æ•°å­—ï¼‰";
  } else {
    if (isUnlocked()) {
      __showPageOriginal(pageName);
      return;
    }
    lockTipEl.textContent = "è¯·è¾“å…¥é¡µé¢é”å¯†ç ";
    lockLabelEl.textContent = "å¯†ç ï¼ˆ4~6 ä½æ•°å­—ï¼‰";
  }

  modal.show();
  setTimeout(() => lockPinEl.focus(), 200);
}

// âœ… ç¡®è®¤æŒ‰é’®
if (__pageLockUiReady) lockOkBtn.onclick = async () => {
  try {
    const pin = lockPinEl.value.trim();
    if (!/^\d{4,6}$/.test(pin)) {
      lockErrEl.textContent = "è¯·è¾“å…¥ 4~6 ä½æ•°å­—";
      lockErrEl.classList.remove("d-none");
      return;
    }

    const cloudHash = await getPageLockHash();
    const inputHash = await sha256(pin);

    // é¦–æ¬¡è®¾ç½®
    if (!cloudHash) {
      await setPageLock(pin);
      setUnlocked();
      lockModalEl && bootstrap.Modal.getInstance(lockModalEl)?.hide();
      showToast("é¡µé¢é”å·²è®¾ç½®ï¼ˆå¤šè®¾å¤‡ç”Ÿæ•ˆï¼‰");
      __showPageOriginal(__pendingPage);
      return;
    }

    // æ ¡éªŒ
    if (inputHash !== cloudHash) {
      lockErrEl.textContent = "å¯†ç é”™è¯¯";
      lockErrEl.classList.remove("d-none");
      return;
    }

    setUnlocked();
    lockModalEl && bootstrap.Modal.getInstance(lockModalEl)?.hide();
    __showPageOriginal(__pendingPage);
  } catch (e) {
    console.error(e);
    lockErrEl.textContent = "éªŒè¯å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯");
    lockErrEl.classList.remove("d-none");
  }
};

if (__pageLockUiReady) lockCancelBtn.onclick = () => {
  lockModalEl && bootstrap.Modal.getInstance(lockModalEl)?.hide();
};

// âœ… é¡µé¢é”é‡ç½®ï¼ˆç®¡ç†å‘˜å¯†ç ï¼‰
if (__pageLockUiReady) lockResetBtn.onclick = async () => {
  const adminPin = prompt("è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥é‡ç½®é¡µé¢é”");
  if (adminPin !== ADMIN_RESET_PIN) {
    alert("ç®¡ç†å‘˜å¯†ç é”™è¯¯ï¼Œæ— æ³•é‡ç½®");
    return;
  }

  const { error } = await sb
    .from("shops")
    .update({ page_lock_hash: null })
    .eq("id", currentShop.id);

  if (error) {
    alert("é‡ç½®å¤±è´¥ï¼š" + error.message);
    return;
  }

  lockNow();
  lockModalEl && bootstrap.Modal.getInstance(lockModalEl)?.hide();
  showToast("é¡µé¢é”å·²é‡ç½®ï¼Œè¯·é‡æ–°è®¾ç½®");
};

// âœ… é‡å†™ showPageï¼šæœªè§£é”æ—¶æ‹¦æˆª Reports
showPage = function(name) {
  if (__pageUnlocked === true) {
    __showPageOriginal(name);
    return;
  }
  if (name === "Reports") {
    requirePageLock(name);
    return;
  }
  __showPageOriginal(name);
};


/********************
 * Buttons
 ********************/
on("btnNewBooking","click", () => openNewBooking());
on("btnRunReport","click", runReport);

on("btnSync","click", async () => {
  try {
    await loadAll();
    showToast("å·²åŒæ­¥");
  } catch (e) {
    console.error(e);
    alert("åŒæ­¥å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
  }
});

on("btnShopInfo","click", () => {
  document.getElementById("shopTitle").textContent = currentShop.name || "æˆ‘çš„åº—é“º";
  document.getElementById("shopCode").textContent = currentShop.join_code || "-";
  document.getElementById("shopIdText").textContent = currentShop.id;
  shopModal && shopModal.show();
});
on("btnCopyShopId","click", async () => {
  try {
    await navigator.clipboard.writeText(currentShop?.id || "");
    showToast("å·²å¤åˆ¶ shop_id");
  } catch { alert("å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨é•¿æŒ‰å¤åˆ¶"); }
});

/********************
 * Calendar init
 ********************/
function initCalendarOnce() {
  if (calendar) return;
  calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {

    eventClassNames: function(arg) {
      try {
        var bookingId = arg.event && arg.event.id ? String(arg.event.id) : "";
        if (!bookingId) return [];
        var inv = (typeof invoiceByBookingId === "function") ? invoiceByBookingId(bookingId) : null;
        if (!inv) return [];
        var paid = Number(inv.amountPaid ?? inv.amount_paid ?? 0);
        var total = Number(inv.amountTotal ?? inv.amount_total ?? 0);
        if (total > 0 && paid >= total) return ["paid-full"];
        if (paid > 0 && paid < total) return ["paid-deposit"];
        return [];
      } catch (e) { return []; }
    },

    
    eventDidMount: function(info) {
      try {
        var bookingId = info.event && info.event.id ? String(info.event.id) : "";
        if (!bookingId) return;
        if (typeof invoiceByBookingId !== "function") return;
        var inv = invoiceByBookingId(bookingId);
        if (!inv) return;

        var paid = Number(inv.amountPaid ?? inv.amount_paid ?? 0);
        var total = Number(inv.amountTotal ?? inv.amount_total ?? 0);

        var el = info.el;
        if (!el) return;

        function applyColor(c) {
          // CSS vars used by FullCalendar themes
          el.style.setProperty("--fc-event-bg-color", c);
          el.style.setProperty("--fc-event-border-color", c);
          el.style.setProperty("--fc-event-text-color", "#fff");
          // Inline fallback
          el.style.backgroundColor = c;
          el.style.borderColor = c;
          el.style.color = "#fff";
          var dot = el.querySelector(".fc-daygrid-event-dot");
          if (dot) dot.style.borderColor = c;
        }

        if (total > 0 && paid >= total) {
          applyColor("#2ecc71"); // green: fully paid
        } else if (paid > 0 && (total <= 0 || paid < total)) {
          applyColor("#e74c3c"); // red: deposit/partial
        }
      } catch (e) { /* ignore */ }
    },
initialView: "timeGridWeek",
    height: "auto",
    locale: "zh-cn",
    headerToolbar: { left: "prev,next today", center: "title", right: "timeGridDay,timeGridWeek"  },

    allDaySlot: false,
    buttonText: { today: "ä»Šå¤©",  week: "å‘¨", day: "æ—¥" },
    slotMinTime: "04:00:00",
    slotMaxTime: "18:01:00",
    slotLabelInterval: "02:00:00",
    slotLabelFormat: { hour: "numeric", minute: "2-digit", hour12: false },
    selectable: true,
    select: (info) => {
      const date = info.startStr.slice(0,10);
      openNewBooking({ date, startTime: "09:00", endTime: "11:00" });
    },
    eventContent: (arg) => {
      const p = arg.event.extendedProps || {};
      const wrap = document.createElement("div");
      const l1 = document.createElement("div");
      l1.style.fontWeight = "600";
      l1.textContent = p.custName || arg.event.title || "";
      const l2 = document.createElement("div");
      l2.style.fontSize = "12px";
      l2.textContent = `${p.serviceName || ""}ï½œ${p.staffName || ""}`;
      const l3 = document.createElement("div");
      l3.style.fontSize = "12px";
      const dep = p.payDeposit ? "å®šé‡‘å·²æ”¶" : "å®šé‡‘æœªæ”¶";
      const bal = p.payFully ? "å°¾æ¬¾å·²ç»“æ¸…" : (p.payDeposit ? "å°¾æ¬¾æœªç»“æ¸…" : "å°¾æ¬¾æœªå¼€å§‹");
      l3.textContent = `${dep}ï½œ${bal}`;
      wrap.appendChild(l1);
      wrap.appendChild(l2);
      wrap.appendChild(l3);
      return { domNodes: [wrap] };
    },
    eventClick: (info) => openEditBooking(info.event.id)
  });
  calendar.render();
  on("btnViewWeek","click", () => calendar.changeView("timeGridWeek"));
  on("btnViewDay","click", () => calendar.changeView("timeGridDay"));
  on("btnViewList","click", () => calendar.changeView("listWeek"));
}

/********************
 * Boot
 ********************/
(async function boot() {
  initCalendarOnce();
  showPage("Calendar");
  await loadShopMeta();
  await loadAll();
  showToast("å·²è¿›å…¥åº—é“ºï¼ˆäº‘åŒæ­¥ï¼‰");

  // è½»é‡è‡ªåŠ¨åˆ·æ–°ï¼šæ¯ 20 ç§’æ‹‰ä¸€æ¬¡
  setInterval(() => loadAll().catch(()=>{}), 20000);
})();
</script>
</body>
</html>


