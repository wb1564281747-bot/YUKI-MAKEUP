<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>åŒ–å¦†åº—é¢„çº¦ & è´¦å•ç³»ç»Ÿï¼ˆäº‘åŒæ­¥Â·å…ç™»å½•ï¼‰</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffffff" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="åŒ–å¦†åº—ç³»ç»Ÿ">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">
  <link rel="icon" href="icons/icon-192.png">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">

  <style>
    body { background:#f7f7f8; padding-bottom: 74px; }
    .card { border-radius: 16px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small-muted { color:#6c757d; font-size: 12px; }
    .pill { border-radius: 999px; padding: 2px 10px; font-size: 12px; display:inline-block; }
    .required::after { content:" *"; color:#dc3545; }

    #calendarWrap { background:#fff; border-radius:16px; padding: 10px; }
    .fc { background:#fff; }
    .fc .fc-toolbar-title { font-size: 16px; }
    .fc .fc-button { padding: .25rem .4rem; font-size: 12px; }
    .fc .fc-col-header-cell-cushion, .fc .fc-daygrid-day-number { font-size: 12px; }

    /* âœ… ä¿®å¤ iPhone ç‚¹å‡»ä¸åˆ°ä¿å­˜ï¼šä¸è¦è®©åº•éƒ¨å¯¼èˆªå‹ä½ modal */
    .bottom-nav {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: #fff;
      border-top: 1px solid #e9ecef;
      padding: 8px 10px;
      z-index: 1020; /* ä½äº bootstrap modal */
      padding-bottom: calc(8px + env(safe-area-inset-bottom));
    }
    .bottom-nav .btn { flex: 1; border-radius: 14px; padding: 10px 0; font-size: 13px; }

    @media (max-width: 576px) {
      .modal-dialog { margin: 0; max-width: 100%; height: 100%; }
      .modal-content { height: 100%; border-radius: 0 !important; }
      .modal-body { overflow-y: auto; padding-bottom: calc(16px + env(safe-area-inset-bottom)); }
      .container { padding-left: 12px; padding-right: 12px; }
    }

    .svc-item { border:1px solid #e9ecef; border-radius:14px; padding:10px; background:#fff; }
    .section-title { font-weight: 600; }

    .ios-install-tip {
      position: sticky;
      top: 56px;
      z-index: 1070;
      background: #fff3cd;
      border: 1px solid #ffe69c;
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 12px;
      display: none;
    }
  </style>
</head>

<body>
<nav class="navbar bg-white border-bottom sticky-top">
  <div class="container d-flex justify-content-between align-items-center">
    <span class="navbar-brand mb-0 fw-semibold" id="appTitle">ğŸ’„ åŒ–å¦†åº—ç³»ç»Ÿï¼ˆäº‘åŒæ­¥Â·å…ç™»å½•ï¼‰</span>
    <div class="d-flex gap-2 align-items-center">
      <button class="btn btn-outline-primary btn-sm" id="btnSync">åŒæ­¥åˆ·æ–°</button>
      <button class="btn btn-outline-secondary btn-sm" id="btnShopInfo">åº—é“º</button>
    </div>
  </div>
</nav>

<div class="container my-3">
  <div class="ios-install-tip" id="iosTip">
    <div class="fw-semibold">ğŸ“Œ å»ºè®®æ·»åŠ åˆ°ä¸»å±å¹•</div>
    <div class="small-muted">Safari ç‚¹ã€åˆ†äº«ã€‘â†’ã€æ·»åŠ åˆ°ä¸»å±å¹•ã€‘ï¼Œä»¥ååƒ App ä¸€æ ·å…¨å±æ‰“å¼€ã€‚</div>
  </div>

  <!-- App -->
  <div id="app">
    <div id="pageCalendar" class="page">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="section-title">ğŸ“… é¢„çº¦</div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary btn-sm" id="btnNewBooking">æ–°å¢é¢„çº¦</button>
          <button class="btn btn-outline-primary btn-sm" id="btnNewInvoiceFromCal">åšè´¦å•</button>
        </div>
      </div>

      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div class="small-muted">æ‰‹æœºæ¨èï¼šå‘¨/æ—¥/åˆ—è¡¨</div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" id="btnViewWeek">å‘¨</button>
              <button class="btn btn-outline-secondary btn-sm" id="btnViewDay">æ—¥</button>
              <button class="btn btn-outline-secondary btn-sm" id="btnViewList">åˆ—è¡¨</button>
            </div>
          </div>
          <div id="calendarWrap" class="mt-2">
            <div id="calendar"></div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <div class="section-title">è¿‘æœŸé¢„çº¦</div>
          <div class="small-muted mb-2" id="todayHint"></div>
          <div id="upcomingList" class="vstack gap-2"></div>
        </div>
      </div>
    </div>

    <div id="pageStaff" class="page d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="section-title">ğŸ‘©â€ğŸ¨ åŒ–å¦†å¸ˆ</div>
        <div class="small-muted" id="staffCount"></div>
      </div>

      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="section-title mb-2">æ–°å¢/ç¼–è¾‘åŒ–å¦†å¸ˆ</div>
          <input type="hidden" id="staffId" />

          <div class="mb-2">
            <label class="form-label required">å§“å</label>
            <input class="form-control" id="staffName" placeholder="ä¾‹å¦‚ï¼šå°ç‹" />
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label required">ææˆæ–¹å¼</label>
              <select class="form-select" id="commissionType">
                <option value="percent">æŒ‰æ¯”ä¾‹ï¼ˆ%ï¼‰</option>
                <option value="fixed">å›ºå®šé‡‘é¢ï¼ˆå…ƒ/å•ï¼‰</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label required">ææˆæ•°å€¼</label>
              <input class="form-control" id="commissionValue" type="number" min="0" step="0.01" placeholder="40 æˆ– 800" />
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary flex-grow-1" id="btnSaveStaff">ä¿å­˜</button>
            <button class="btn btn-outline-secondary" id="btnClearStaff">æ¸…ç©º</button>
          </div>

          <hr class="my-3"/>

          <div class="section-title mb-2">è¯¥åŒ–å¦†å¸ˆçš„é¡¹ç›®/é‡‘é¢</div>
          <div class="small-muted mb-2">æ¯ä¸ªåŒ–å¦†å¸ˆå¯æœ‰ä¸åŒé¡¹ç›®ï¼Œä¸åŒé‡‘é¢ã€‚</div>

          <div class="row g-2">
            <div class="col-7">
              <input class="form-control" id="svcName" placeholder="é¡¹ç›®åç§°ï¼šæ–°å¨˜è·Ÿå¦†..." />
            </div>
            <div class="col-5">
              <input class="form-control" id="svcPrice" type="number" min="0" step="0.01" placeholder="é‡‘é¢" />
            </div>
          </div>
          <div class="d-flex gap-2 mt-2">
            <button class="btn btn-outline-primary flex-grow-1" id="btnAddService">æ·»åŠ é¡¹ç›®</button>
            <button class="btn btn-outline-secondary" id="btnClearServiceInput">æ¸…ç©º</button>
          </div>

          <div class="vstack gap-2 mt-3" id="serviceList"></div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <div class="section-title mb-2">åŒ–å¦†å¸ˆåˆ—è¡¨</div>
          <div id="staffCards" class="vstack gap-2"></div>
        </div>
      </div>
    </div>

    <div id="pageInvoices" class="page d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="section-title">ğŸ§¾ è´¦å•</div>
        <button class="btn btn-primary btn-sm" id="btnNewInvoice">æ–°å¢è´¦å•</button>
      </div>

      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <input class="form-control" id="invoiceSearch" placeholder="æœç´¢ï¼šå®¢æˆ·/é¡¹ç›®/å‘˜å·¥/å¤‡æ³¨/çŠ¶æ€" />
          <div class="small-muted mt-2">
            äº‘åŒæ­¥ï¼šä¿å­˜å³å†™å…¥äº‘ç«¯ï¼›å…¶ä»–è®¾å¤‡ç‚¹â€œåŒæ­¥åˆ·æ–°â€æˆ–ç­‰å¾…è‡ªåŠ¨åˆ·æ–°å³å¯çœ‹åˆ°æœ€æ–°æ•°æ®ã€‚
          </div>
        </div>
      </div>

      <div id="invoiceCards" class="vstack gap-2"></div>
    </div>

    <div id="pageReports" class="page d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="section-title">ğŸ“Š æŠ¥è¡¨</div>
        <button class="btn btn-primary btn-sm" id="btnRunReport">ç”Ÿæˆ</button>
      </div>

      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">å¼€å§‹</label>
              <input type="date" class="form-control" id="repStart">
            </div>
            <div class="col-6">
              <label class="form-label">ç»“æŸ</label>
              <input type="date" class="form-control" id="repEnd">
            </div>
          </div>
        </div>
      </div>

      <div class="row g-2">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="small-muted">è¥ä¸šé¢ï¼ˆåº”æ”¶ï¼Œæ’é™¤ä½œåºŸï¼‰</div>
              <div class="fs-3 fw-semibold mono" id="repTotal">0.00</div>
            </div>
          </div>
        </div>

        <div class="col-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="small-muted">å®æ”¶</div>
              <div class="fs-5 fw-semibold mono" id="repPaid">0.00</div>
            </div>
          </div>
        </div>
        <div class="col-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="small-muted">æœªæ”¶</div>
              <div class="fs-5 fw-semibold mono" id="repUnpaid">0.00</div>
            </div>
          </div>
        </div>

        <div class="col-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="small-muted">å·²æ”¶å®šé‡‘</div>
              <div class="fs-5 fw-semibold mono" id="repDepositPaid">0.00</div>
            </div>
          </div>
        </div>
        <div class="col-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="small-muted">æœªæ”¶å°¾æ¬¾</div>
              <div class="fs-5 fw-semibold mono" id="repBalanceUnpaid">0.00</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="section-title">æŒ‰åŒ–å¦†å¸ˆç»Ÿè®¡</div>
          <div id="repStaffCards" class="vstack gap-2 mt-2"></div>
        </div>
      </div>

      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="section-title">æœªç»“æ¸…è´¦å•</div>
          <div class="small-muted">æ–¹ä¾¿è¿½å°¾æ¬¾ï¼ˆä¸å«ä½œåºŸï¼‰</div>
          <div id="repOpenInvoices" class="vstack gap-2 mt-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bottom nav -->
<div class="bottom-nav" id="bottomNav">
  <div class="container d-flex gap-2">
    <button class="btn btn-outline-primary" data-page="Calendar">é¢„çº¦</button>
    <button class="btn btn-outline-primary" data-page="Staff">åŒ–å¦†å¸ˆ</button>
    <button class="btn btn-outline-primary" data-page="Invoices">è´¦å•</button>
    <button class="btn btn-outline-primary" data-page="Reports">æŠ¥è¡¨</button>
  </div>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content" style="border-radius: 16px;">
      <div class="modal-header">
        <h5 class="modal-title">é¢„çº¦å•</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="bookingId">

        <div class="mb-2">
          <label class="form-label required">å®¢æˆ·å§“å</label>
          <input class="form-control" id="custName" placeholder="ä¾‹å¦‚ï¼šå¼ å°å§">
        </div>
        <div class="mb-2">
          <label class="form-label">æ‰‹æœºå·</label>
          <input class="form-control" id="custPhone" placeholder="å¯é€‰">
        </div>

        <div class="mb-2">
          <label class="form-label required">åŒ–å¦†å¸ˆ</label>
          <select class="form-select" id="staffSelect"></select>
        </div>

        <div class="mb-2">
          <label class="form-label required">æœåŠ¡é¡¹ç›®</label>
          <select class="form-select" id="serviceSelect"></select>
          <div class="small-muted mt-1">é¡¹ç›®æ¥è‡ªè¯¥åŒ–å¦†å¸ˆçš„â€œé¡¹ç›®/é‡‘é¢â€ã€‚</div>
        </div>

        <div class="row g-2">
          <div class="col-6">
            <label class="form-label required">æ—¥æœŸ</label>
            <input class="form-control" id="bookDate" type="date">
          </div>
          <div class="col-6">
            <label class="form-label">çŠ¶æ€</label>
            <select class="form-select" id="bookingStatus">
              <option value="å·²é¢„çº¦">å·²é¢„çº¦</option>
              <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
              <option value="å·²å–æ¶ˆ">å·²å–æ¶ˆ</option>
            </select>
          </div>
        </div>

        <div class="row g-2 mt-1">
          <div class="col-6">
            <label class="form-label required">å¼€å§‹æ—¶é—´</label>
            <input class="form-control" id="startTime" type="time">
          </div>
          <div class="col-6">
            <label class="form-label required">ç»“æŸæ—¶é—´</label>
            <input class="form-control" id="endTime" type="time">
          </div>
        </div>

        <div class="mt-2">
          <label class="form-label">å¤‡æ³¨</label>
          <input class="form-control" id="bookingNote" placeholder="ä¾‹å¦‚ï¼šä¸Šé—¨ / éœ€è‡ªå¸¦å‡ç«æ¯›">
        </div>

        <div class="alert alert-warning mt-3 d-none" id="conflictAlert"></div>
        <div class="small-muted">é˜²å†²çªï¼šåŒä¸€åŒ–å¦†å¸ˆåŒä¸€æ—¶é—´æ®µä¸å¯é‡å¤é¢„çº¦ï¼ˆå·²å–æ¶ˆä¸ç®—å†²çªï¼‰ã€‚</div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-danger me-auto" id="btnDeleteBooking">åˆ é™¤</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">å…³é—­</button>
        <button class="btn btn-primary" id="btnSaveBooking">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- Invoice Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content" style="border-radius: 16px;">
      <div class="modal-header">
        <h5 class="modal-title">è´¦å•ï¼ˆå®šé‡‘/å°¾æ¬¾ï¼‰</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="invoiceId" />

        <div class="mb-2">
          <label class="form-label">ç»‘å®šé¢„çº¦ï¼ˆå»ºè®®ï¼‰</label>
          <select class="form-select" id="invoiceBooking"></select>
          <div class="small-muted mt-1" id="invoiceAutoInfo"></div>
        </div>

        <div class="row g-2">
          <div class="col-6">
            <label class="form-label required">åº”æ”¶æ€»é¢</label>
            <input class="form-control" id="amountTotal" type="number" min="0" step="0.01" />
          </div>
          <div class="col-6">
            <label class="form-label required">å®šé‡‘ï¼ˆå¯æ”¹ï¼‰</label>
            <input class="form-control" id="depositDue" type="number" min="0" step="0.01" />
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-6">
            <label class="form-label">å·²æ”¶åˆè®¡</label>
            <input class="form-control" id="amountPaid" type="number" min="0" step="0.01" />
          </div>
          <div class="col-6">
            <label class="form-label">æ”¶æ¬¾æ–¹å¼</label>
            <select class="form-select" id="payMethod">
              <option value="å¾®ä¿¡">å¾®ä¿¡</option>
              <option value="æ”¯ä»˜å®">æ”¯ä»˜å®</option>
              <option value="ç°é‡‘">ç°é‡‘</option>
              <option value="é“¶è¡Œå¡">é“¶è¡Œå¡</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-6">
            <label class="form-label">è´¦å•çŠ¶æ€</label>
            <select class="form-select" id="invoiceStatus">
              <option value="AUTO">è‡ªåŠ¨ï¼ˆæ¨èï¼‰</option>
              <option value="VOID">ä½œåºŸ</option>
            </select>
            <div class="small-muted mt-1" id="statusHint"></div>
          </div>
          <div class="col-6">
            <label class="form-label">å°¾æ¬¾ï¼ˆè‡ªåŠ¨ï¼‰</label>
            <input class="form-control" id="balanceDue" type="number" disabled />
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-outline-primary flex-grow-1" id="btnQuickDeposit">å¿«æ·ï¼šæ”¶å®šé‡‘</button>
          <button class="btn btn-outline-success flex-grow-1" id="btnQuickPaidAll">å¿«æ·ï¼šç»“æ¸…</button>
        </div>

        <div class="mt-2">
          <label class="form-label">å¤‡æ³¨</label>
          <input class="form-control" id="invoiceNote" placeholder="å®šé‡‘/å°¾æ¬¾è¯´æ˜ç­‰" />
        </div>

        <div class="mt-3">
          <div class="section-title">å†å²è®°å½•</div>
          <div class="small-muted" id="invoiceHistory">æš‚æ— </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">å…³é—­</button>
        <button class="btn btn-primary" id="btnSaveInvoice">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- Owner Lock Modal (Mode B) -->
<div class="modal fade" id="lockModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px;">
      <div class="modal-header">
        <h5 class="modal-title">ğŸ”’ è€æ¿é”</h5>
      </div>
      <div class="modal-body">
        <div class="small-muted mb-2" id="lockTip">è¿›å…¥è´¦å•/æŠ¥è¡¨éœ€è¦å¯†ç </div>

        <div class="mb-2">
          <label class="form-label required" id="lockLabel">å¯†ç ï¼ˆ4~6ä½æ•°å­—ï¼‰</label>
          <input id="lockPin" class="form-control" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="è¯·è¾“å…¥æ•°å­—å¯†ç ">
        </div>

        <div class="alert alert-danger d-none" id="lockErr"></div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-outline-secondary flex-grow-1" id="lockCancel">å–æ¶ˆ</button>
          <button class="btn btn-primary flex-grow-1" id="lockOk">ç¡®å®š</button>
        </div>

        <hr class="my-3"/>

        <button class="btn btn-outline-danger w-100" id="lockReset">å¿˜è®°å¯†ç /é‡è®¾ï¼ˆéœ€è¦ç¡®è®¤ï¼‰</button>
        <div class="small-muted mt-2">å¯†ç åªä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨é‡Œï¼Œä¸ä¼šä¸Šä¼ ã€‚</div>
      </div>
    </div>
  </div>
</div>

<!-- Shop info modal -->
<div class="modal fade" id="shopModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px;">
      <div class="modal-header">
        <h5 class="modal-title">ğŸª åº—é“ºä¿¡æ¯</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="small-muted">å½“å‰åº—é“º</div>
        <div class="fw-semibold" id="shopTitle">-</div>
        <div class="small-muted mt-2">åº—é“ºç ï¼ˆå±•ç¤ºç”¨ï¼‰</div>
        <div class="mono fs-5" id="shopCode">-</div>
        <div class="small-muted mt-2">å½“å‰ shop_id</div>
        <div class="mono" id="shopIdText">-</div>
        <button class="btn btn-outline-primary w-100 mt-3" id="btnCopyShopId">å¤åˆ¶ shop_id</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
  <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastText">å·²ä¿å­˜</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/********************
 * Configï¼ˆä½ çš„ï¼‰
 ********************/
const SUPABASE_URL = "https://pqnrhzmhnajezkivpfks.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxbnJoem1obmFqZXpraXZwZmtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MzkzMjUsImV4cCI6MjA4NDAxNTMyNX0.NqnjHHhAxZIloSRdBPIApNZi4e_lVb57MUSXBxxmbWc";
const SHOP_ID = "71798af3-a79e-4ffb-90d5-5026513233a1";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const DEFAULT_DEPOSIT = 500;

/********************
 * iPhone install tip + SW
 ********************/
(function () {
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isInStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
  const isSafari = isIOS && /safari/i.test(navigator.userAgent) && !/crios|fxios|edgios/i.test(navigator.userAgent);
  const tip = document.getElementById("iosTip");
  if (isSafari && !isInStandalone) tip.style.display = "block";
  if ("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js").catch(()=>{});
})();
</script>

<script>
/********************
 * In-Memory DB (cloud-backed)
 ********************/
let DB = { staff: [], bookings: [], invoices: [] };

let currentShop = { id: SHOP_ID, name: "æˆ‘çš„åº—é“º", join_code: "-" };

const fmtMoney = (n) => (Number(n || 0)).toFixed(2);
const fmtDateTime = (iso) => new Date(iso).toLocaleString("zh-CN", { hour12:false });
function showToast(msg) {
  document.getElementById("toastText").textContent = msg;
  new bootstrap.Toast(document.getElementById("toast"), { delay: 1600 }).show();
}
function uuid() { return (crypto?.randomUUID ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2)+"_"+Date.now())); }

function staffById(id) { return DB.staff.find(s => s.id === id); }
function bookingById(id) { return DB.bookings.find(b => b.id === id); }
function invoiceById(id) { return DB.invoices.find(i => i.id === id); }

function dateToISO(dateStr, timeStr) { return new Date(dateStr + "T" + timeStr + ":00").toISOString(); }
function overlap(aStart, aEnd, bStart, bEnd) { return (aStart < bEnd) && (bStart < aEnd); }

function calcCommission(staff, amountBase) {
  if (!staff) return 0;
  const base = Number(amountBase || 0);
  if (staff.commission_type === "percent") return base * (Number(staff.commission_value || 0) / 100);
  return Number(staff.commission_value || 0);
}
function autoStatus(total, paid, depositDue) {
  total = Number(total||0);
  paid = Number(paid||0);
  depositDue = Math.max(0, Number(depositDue||0));
  if (paid <= 0.00001) return "UNPAID";
  if (paid + 0.00001 < depositDue) return "DEPOSIT";
  if (paid + 0.00001 < total) return "PARTIAL";
  return "PAID";
}
function statusLabel(st) {
  if (st === "VOID") return "ä½œåºŸ";
  if (st === "UNPAID") return "æœªæ”¶";
  if (st === "DEPOSIT") return "å·²æ”¶å®šé‡‘";
  if (st === "PARTIAL") return "éƒ¨åˆ†æ”¶";
  if (st === "PAID") return "å·²ç»“æ¸…";
  return st;
}
function invoiceBadge(inv) {
  const st = inv.statusFinal || inv.status_final || "UNPAID";
  if (st === "VOID") return { text: "ä½œåºŸ", cls: "bg-secondary text-white" };
  if (st === "PAID") return { text: "å·²ç»“æ¸…", cls: "bg-success text-white" };
  if (st === "PARTIAL") return { text: "éƒ¨åˆ†æ”¶", cls: "bg-primary text-white" };
  if (st === "DEPOSIT") return { text: "å·²æ”¶å®šé‡‘", cls: "bg-info text-dark" };
  return { text: "æœªæ”¶", cls: "bg-warning text-dark" };
}

/********************
 * Cloud: shop meta
 ********************/
async function loadShopMeta() {
  try {
    const { data, error } = await sb.from("shops").select("*").eq("id", SHOP_ID).maybeSingle();
    if (error) throw error;
    if (data) {
      currentShop = data;
      document.getElementById("appTitle").textContent = `ğŸ’„ ${data.name}ï¼ˆäº‘åŒæ­¥Â·å…ç™»å½•ï¼‰`;
    } else {
      currentShop = { id: SHOP_ID, name: "æˆ‘çš„åº—é“º", join_code: "-" };
    }
  } catch {
    currentShop = { id: SHOP_ID, name: "æˆ‘çš„åº—é“º", join_code: "-" };
  }
}

/********************
 * Cloud sync: load all
 ********************/
async function loadAll() {
  // staff
  const { data: staff, error: e1 } = await sb
    .from("staff")
    .select("*")
    .eq("shop_id", currentShop.id)
    .order("created_at", { ascending: true });
  if (e1) throw e1;

  // services
  const { data: svcs, error: e2 } = await sb
    .from("staff_services")
    .select("*")
    .eq("shop_id", currentShop.id)
    .order("created_at", { ascending: true });
  if (e2) throw e2;

  // bookings
  const { data: bookings, error: e3 } = await sb
    .from("bookings")
    .select("*")
    .eq("shop_id", currentShop.id)
    .order("start_iso", { ascending: true });
  if (e3) throw e3;

  // invoices
  const { data: invoices, error: e4 } = await sb
    .from("invoices")
    .select("*")
    .eq("shop_id", currentShop.id)
    .order("created_at", { ascending: false });
  if (e4) throw e4;

  // stitch services into staff
  const staffMap = new Map((staff||[]).map(s => [s.id, { ...s, services: [] }]));
  (svcs||[]).forEach(svc => {
    const st = staffMap.get(svc.staff_id);
    if (st) st.services.push({ id: svc.id, name: svc.name, price: Number(svc.price||0) });
  });

  DB.staff = Array.from(staffMap.values());
  DB.bookings = (bookings||[]).map(b => ({
    ...b,
    servicePrice: Number(b.service_price||0),
    startISO: b.start_iso,
    endISO: b.end_iso,
    custName: b.cust_name,
    custPhone: b.cust_phone,
    staffId: b.staff_id,
    serviceId: b.service_id,
    serviceName: b.service_name,
    startTime: b.start_time,
    endTime: b.end_time,
    note: b.note,
    status: b.status,
    date: b.date
  }));
  DB.invoices = (invoices||[]).map(inv => ({
    ...inv,
    bookingId: inv.booking_id,
    amountTotal: Number(inv.amount_total||0),
    depositDue: Number(inv.deposit_due||DEFAULT_DEPOSIT),
    amountPaid: Number(inv.amount_paid||0),
    payMethod: inv.pay_method,
    statusManual: inv.status_manual,
    statusFinal: inv.status_final,
    note: inv.note,
    history: Array.isArray(inv.history) ? inv.history : (inv.history || [])
  }));

  refreshAll();
}

/********************
 * CRUD: Staff & Services
 ********************/
async function upsertStaff(st) {
  const payload = {
    id: st.id || uuid(),
    shop_id: currentShop.id,
    name: st.name,
    commission_type: st.commissionType,
    commission_value: st.commissionValue,
    updated_at: new Date().toISOString()
  };
  if (!st.id) payload.created_at = new Date().toISOString();

  const { error } = await sb.from("staff").upsert(payload);
  if (error) throw error;
  return payload.id;
}
async function deleteStaffCloud(staffId) {
  const { error } = await sb.from("staff").delete().eq("id", staffId).eq("shop_id", currentShop.id);
  if (error) throw error;
}
async function upsertServiceCloud(staffId, svc) {
  const payload = {
    id: svc.id || uuid(),
    shop_id: currentShop.id,
    staff_id: staffId,
    name: svc.name,
    price: svc.price,
    updated_at: new Date().toISOString()
  };
  if (!svc.id) payload.created_at = new Date().toISOString();

  const { error } = await sb.from("staff_services").upsert(payload);
  if (error) throw error;
  return payload.id;
}
async function deleteServiceCloud(serviceId) {
  const { error } = await sb.from("staff_services").delete().eq("id", serviceId).eq("shop_id", currentShop.id);
  if (error) throw error;
}

/********************
 * CRUD: Booking
 ********************/
async function upsertBookingCloud(b) {
  const payload = {
    id: b.id || uuid(),
    shop_id: currentShop.id,
    cust_name: b.custName,
    cust_phone: b.custPhone || null,
    staff_id: b.staffId,
    service_id: b.serviceId,
    service_name: b.serviceName,
    service_price: b.servicePrice,
    date: b.date,
    start_time: b.startTime,
    end_time: b.endTime,
    start_iso: b.startISO,
    end_iso: b.endISO,
    status: b.status,
    note: b.note || null,
    updated_at: new Date().toISOString()
  };
  if (!b.id) payload.created_at = new Date().toISOString();

  const { error } = await sb.from("bookings").upsert(payload);
  if (error) throw error;
  return payload.id;
}
async function deleteBookingCloud(id) {
  const { error } = await sb.from("bookings").delete().eq("id", id).eq("shop_id", currentShop.id);
  if (error) throw error;
}

/********************
 * CRUD: Invoice
 ********************/
async function upsertInvoiceCloud(inv) {
  const payload = {
    id: inv.id || uuid(),
    shop_id: currentShop.id,
    booking_id: inv.bookingId || null,
    amount_total: inv.amountTotal,
    deposit_due: inv.depositDue,
    amount_paid: inv.amountPaid,
    pay_method: inv.payMethod || null,
    note: inv.note || null,
    status_manual: inv.statusManual || "AUTO",
    status_final: inv.statusFinal || "UNPAID",
    history: inv.history || [],
    updated_at: new Date().toISOString()
  };
  if (!inv.id) payload.created_at = new Date().toISOString();

  const { error } = await sb.from("invoices").upsert(payload);
  if (error) throw error;
  return payload.id;
}
async function deleteInvoiceCloud(id) {
  const { error } = await sb.from("invoices").delete().eq("id", id).eq("shop_id", currentShop.id);
  if (error) throw error;
}

/********************
 * Routing
 ********************/
function showPage(name) {
  ["Calendar","Staff","Invoices","Reports"].forEach(p => {
    document.getElementById("page"+p).classList.toggle("d-none", p !== name);
  });
  document.querySelectorAll(".bottom-nav .btn").forEach(btn => {
    const active = btn.dataset.page === name;
    btn.classList.toggle("btn-primary", active);
    btn.classList.toggle("btn-outline-primary", !active);
  });
}
document.querySelectorAll(".bottom-nav .btn").forEach(btn => {
  btn.addEventListener("click", () => showPage(btn.dataset.page));
});

/********************
 * Calendar
 ********************/
let calendar;
const bookingModal = new bootstrap.Modal(document.getElementById("bookingModal"));
const invoiceModal = new bootstrap.Modal(document.getElementById("invoiceModal"));
const shopModal = new bootstrap.Modal(document.getElementById("shopModal"));

function bookingToEvent(b) {
  const st = staffById(b.staffId);
  return {
    id: b.id,
    title: `${b.custName}ï½œ${b.serviceName || ""}ï½œ${st ? st.name : "å‘˜å·¥å·²åˆ "}ï½œ${b.status}`,
    start: b.startISO,
    end: b.endISO
  };
}
function refreshCalendar() {
  if (!calendar) return;
  calendar.removeAllEvents();
  DB.bookings.forEach(b => calendar.addEvent(bookingToEvent(b)));
}
function fillStaffSelect(selectEl, selectedId=null) {
  selectEl.innerHTML = "";
  DB.staff.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${s.name}ï¼ˆ${s.commission_type === "percent" ? s.commission_value+"%": fmtMoney(s.commission_value)+"å…ƒ/å•"}ï¼‰`;
    if (selectedId && selectedId === s.id) opt.selected = true;
    selectEl.appendChild(opt);
  });
  if (!DB.staff.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "è¯·å…ˆåœ¨ã€åŒ–å¦†å¸ˆã€‘é‡Œæ–°å¢";
    selectEl.appendChild(opt);
  }
}
function fillServiceSelectByStaff(serviceSelectEl, staffId, selectedServiceId=null) {
  serviceSelectEl.innerHTML = "";
  const st = staffById(staffId);
  const svcs = st?.services || [];
  if (!svcs.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "è¯¥åŒ–å¦†å¸ˆæš‚æ— é¡¹ç›®ï¼ˆå»åŒ–å¦†å¸ˆé¡µæ·»åŠ ï¼‰";
    serviceSelectEl.appendChild(opt);
    return;
  }
  svcs.forEach(svc => {
    const opt = document.createElement("option");
    opt.value = svc.id;
    opt.textContent = `${svc.name}ï¼ˆ${fmtMoney(svc.price)}ï¼‰`;
    if (selectedServiceId && selectedServiceId === svc.id) opt.selected = true;
    serviceSelectEl.appendChild(opt);
  });
}
document.getElementById("staffSelect").addEventListener("change", () => {
  const staffId = document.getElementById("staffSelect").value;
  fillServiceSelectByStaff(document.getElementById("serviceSelect"), staffId);
});

function openNewBooking(prefill={}) {
  document.getElementById("bookingId").value = "";
  document.getElementById("custName").value = prefill.custName || "";
  document.getElementById("custPhone").value = prefill.custPhone || "";
  document.getElementById("bookDate").value = prefill.date || new Date().toISOString().slice(0,10);
  document.getElementById("startTime").value = prefill.startTime || "09:00";
  document.getElementById("endTime").value = prefill.endTime || "11:00";

  fillStaffSelect(document.getElementById("staffSelect"), prefill.staffId || (DB.staff[0]?.id ?? null));
  const staffId = document.getElementById("staffSelect").value;
  fillServiceSelectByStaff(document.getElementById("serviceSelect"), staffId, prefill.serviceId || null);

  document.getElementById("bookingStatus").value = prefill.status || "å·²é¢„çº¦";
  document.getElementById("bookingNote").value = prefill.note || "";

  document.getElementById("btnDeleteBooking").classList.add("d-none");
  document.getElementById("conflictAlert").classList.add("d-none");
  bookingModal.show();
}
function openEditBooking(id) {
  const b = bookingById(id);
  if (!b) return;
  document.getElementById("bookingId").value = b.id;
  document.getElementById("custName").value = b.custName;
  document.getElementById("custPhone").value = b.custPhone || "";
  document.getElementById("bookDate").value = b.date;
  document.getElementById("startTime").value = b.startTime;
  document.getElementById("endTime").value = b.endTime;

  fillStaffSelect(document.getElementById("staffSelect"), b.staffId);
  fillServiceSelectByStaff(document.getElementById("serviceSelect"), b.staffId, b.serviceId || null);

  document.getElementById("bookingStatus").value = b.status;
  document.getElementById("bookingNote").value = b.note || "";

  document.getElementById("btnDeleteBooking").classList.remove("d-none");
  document.getElementById("conflictAlert").classList.add("d-none");
  bookingModal.show();
}
function validateBooking(payload) {
  const errs = [];
  if (!payload.custName.trim()) errs.push("å®¢æˆ·å§“åå¿…å¡«");
  if (!payload.staffId) errs.push("åŒ–å¦†å¸ˆå¿…é€‰");
  if (!payload.serviceId) errs.push("é¡¹ç›®å¿…é€‰");
  if (!payload.date || !payload.startTime || !payload.endTime) errs.push("æ—¥æœŸ/æ—¶é—´å¿…å¡«");
  const a = dateToISO(payload.date, payload.startTime);
  const b = dateToISO(payload.date, payload.endTime);
  if (a >= b) errs.push("ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´");

  const conflict = DB.bookings.some(x => {
    if (payload.id && x.id === payload.id) return false;
    if (x.staffId !== payload.staffId) return false;
    if (x.status === "å·²å–æ¶ˆ") return false;
    return overlap(a, b, x.startISO, x.endISO);
  });
  return { errs, conflict, startISO: a, endISO: b };
}

document.getElementById("btnSaveBooking").addEventListener("click", async () => {
  try {
    const id = document.getElementById("bookingId").value || null;
    const payload = {
      id,
      custName: document.getElementById("custName").value,
      custPhone: document.getElementById("custPhone").value,
      staffId: document.getElementById("staffSelect").value,
      serviceId: document.getElementById("serviceSelect").value,
      date: document.getElementById("bookDate").value,
      startTime: document.getElementById("startTime").value,
      endTime: document.getElementById("endTime").value,
      status: document.getElementById("bookingStatus").value,
      note: document.getElementById("bookingNote").value
    };

    const { errs, conflict, startISO, endISO } = validateBooking(payload);
    const alertBox = document.getElementById("conflictAlert");

    if (errs.length) { alertBox.textContent = errs.join("ï¼›"); alertBox.classList.remove("d-none"); return; }
    if (conflict) { alertBox.textContent = "é¢„çº¦å†²çªï¼šè¯¥åŒ–å¦†å¸ˆåœ¨æ­¤æ—¶é—´æ®µå·²æœ‰é¢„çº¦ã€‚"; alertBox.classList.remove("d-none"); return; }
    alertBox.classList.add("d-none");

    const st = staffById(payload.staffId);
    const svc = st?.services?.find(x => x.id === payload.serviceId);
    if (!svc) return alert("é¡¹ç›®æ— æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©");

    const record = {
      id: payload.id || uuid(),
      custName: payload.custName.trim(),
      custPhone: payload.custPhone.trim(),
      staffId: payload.staffId,
      serviceId: payload.serviceId,
      serviceName: svc.name,
      servicePrice: Number(svc.price || 0),
      date: payload.date,
      startTime: payload.startTime,
      endTime: payload.endTime,
      startISO,
      endISO,
      status: payload.status,
      note: payload.note.trim()
    };

    await upsertBookingCloud(record);
    await loadAll();
    bookingModal.hide();
    showToast(id ? "é¢„çº¦å·²æ›´æ–°" : "é¢„çº¦å·²æ–°å¢");
  } catch (e) {
    console.error(e);
    alert("ä¿å­˜å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
  }
});

document.getElementById("btnDeleteBooking").addEventListener("click", async () => {
  const id = document.getElementById("bookingId").value;
  if (!id) return;
  if (!confirm("ç¡®å®šåˆ é™¤è¯¥é¢„çº¦ï¼Ÿï¼ˆè´¦å•ä¸ä¼šè‡ªåŠ¨åˆ é™¤ï¼‰")) return;
  try {
    await deleteBookingCloud(id);
    await loadAll();
    bookingModal.hide();
    showToast("é¢„çº¦å·²åˆ é™¤");
  } catch (e) {
    console.error(e);
    alert("åˆ é™¤å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
  }
});

/********************
 * Staff Page render + actions
 ********************/
function renderStaff() {
  document.getElementById("staffCount").textContent = `å…± ${DB.staff.length} ä½`;
  const box = document.getElementById("staffCards");
  box.innerHTML = "";

  if (!DB.staff.length) { box.innerHTML = `<div class="small-muted">æš‚æ— åŒ–å¦†å¸ˆï¼Œè¯·å…ˆæ–°å¢ã€‚</div>`; return; }

  DB.staff.forEach(s => {
    const rule = s.commission_type === "percent" ? `${s.commission_value}%` : `${fmtMoney(s.commission_value)} å…ƒ/å•`;
    const div = document.createElement("div");
    div.className = "card border-0 shadow-sm";
    div.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-semibold">${s.name}</div>
            <div class="small-muted">ææˆï¼š<span class="mono">${rule}</span></div>
            <div class="small-muted">é¡¹ç›®æ•°ï¼š<span class="mono">${(s.services||[]).length}</span></div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary btn-sm" data-act="edit" data-id="${s.id}">ç¼–è¾‘</button>
            <button class="btn btn-outline-danger btn-sm" data-act="del" data-id="${s.id}">åˆ é™¤</button>
          </div>
        </div>
      </div>
    `;
    box.appendChild(div);
  });

  box.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", async () => {
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if (act === "edit") openEditStaff(id);
      if (act === "del") {
        if (!confirm("ç¡®å®šåˆ é™¤è¯¥åŒ–å¦†å¸ˆï¼Ÿå†å²å•æ®ä¼šæ˜¾ç¤ºâ€œå‘˜å·¥å·²åˆ é™¤â€ã€‚")) return;
        try {
          await deleteStaffCloud(id);
          await loadAll();
          showToast("å·²åˆ é™¤");
        } catch (e) {
          console.error(e);
          alert("åˆ é™¤å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
        }
      }
    });
  });
}

function openEditStaff(id) {
  const s = staffById(id);
  if (!s) return;
  document.getElementById("staffId").value = s.id;
  document.getElementById("staffName").value = s.name;
  document.getElementById("commissionType").value = s.commission_type;
  document.getElementById("commissionValue").value = s.commission_value;
  renderServiceListForCurrentStaff();
}
function currentStaffId() { return document.getElementById("staffId").value || ""; }

function renderServiceListForCurrentStaff() {
  const staffId = currentStaffId();
  const listEl = document.getElementById("serviceList");
  listEl.innerHTML = "";

  if (!staffId) { listEl.innerHTML = `<div class="small-muted">å…ˆä¿å­˜/é€‰æ‹©åŒ–å¦†å¸ˆï¼Œå†æ·»åŠ é¡¹ç›®ã€‚</div>`; return; }
  const st = staffById(staffId);
  if (!st) return;

  const svcs = st.services || [];
  if (!svcs.length) { listEl.innerHTML = `<div class="small-muted">æš‚æ— é¡¹ç›®ï¼Œä½¿ç”¨ä¸Šæ–¹è¾“å…¥æ¡†æ·»åŠ ã€‚</div>`; return; }

  svcs.forEach(svc => {
    const div = document.createElement("div");
    div.className = "svc-item";
    div.innerHTML = `
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="fw-semibold">${svc.name}</div>
          <div class="small-muted">é‡‘é¢ï¼š<span class="mono">${fmtMoney(svc.price)}</span></div>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" data-act="editSvc" data-id="${svc.id}">æ”¹</button>
          <button class="btn btn-outline-danger btn-sm" data-act="delSvc" data-id="${svc.id}">åˆ </button>
        </div>
      </div>
    `;
    listEl.appendChild(div);
  });

  listEl.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", async () => {
      const act = btn.dataset.act;
      const svcId = btn.dataset.id;
      const st = staffById(currentStaffId());
      if (!st) return;

      if (act === "delSvc") {
        if (!confirm("ç¡®å®šåˆ é™¤è¯¥é¡¹ç›®ï¼Ÿå†å²é¢„çº¦ä¿ç•™é¡¹ç›®åç§°/ä»·æ ¼å¿«ç…§ã€‚")) return;
        try {
          await deleteServiceCloud(svcId);
          await loadAll();
          renderServiceListForCurrentStaff();
          showToast("é¡¹ç›®å·²åˆ é™¤");
        } catch (e) {
          console.error(e);
          alert("åˆ é™¤å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
        }
      }

      if (act === "editSvc") {
        const svc = (st.services || []).find(x => x.id === svcId);
        if (!svc) return;
        const newName = prompt("é¡¹ç›®åç§°ï¼š", svc.name);
        if (newName === null) return;
        const newPriceStr = prompt("é‡‘é¢ï¼š", String(svc.price ?? 0));
        if (newPriceStr === null) return;
        const newPrice = Number(newPriceStr);
        if (!newName.trim()) return alert("åç§°ä¸èƒ½ä¸ºç©º");
        if (Number.isNaN(newPrice) || newPrice < 0) return alert("é‡‘é¢å¿…é¡»>=0");
        try {
          await upsertServiceCloud(st.id, { id: svcId, name: newName.trim(), price: newPrice });
          await loadAll();
          renderServiceListForCurrentStaff();
          showToast("å·²ä¿®æ”¹");
        } catch (e) {
          console.error(e);
          alert("ä¿®æ”¹å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
        }
      }
    });
  });
}

document.getElementById("btnSaveStaff").addEventListener("click", async () => {
  try {
    const id = document.getElementById("staffId").value || null;
    const name = document.getElementById("staffName").value.trim();
    const commissionType = document.getElementById("commissionType").value;
    const commissionValue = Number(document.getElementById("commissionValue").value);

    if (!name) return alert("å§“åå¿…å¡«");
    if (Number.isNaN(commissionValue) || commissionValue < 0) return alert("ææˆæ•°å€¼å¿…é¡»>=0");

    const staffId = await upsertStaff({ id, name, commissionType, commissionValue });
    document.getElementById("staffId").value = staffId;

    await loadAll();
    renderServiceListForCurrentStaff();
    showToast("å·²ä¿å­˜");
  } catch (e) {
    console.error(e);
    alert("ä¿å­˜å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
  }
});
document.getElementById("btnClearStaff").addEventListener("click", () => {
  document.getElementById("staffId").value = "";
  document.getElementById("staffName").value = "";
  document.getElementById("commissionType").value = "percent";
  document.getElementById("commissionValue").value = "";
  document.getElementById("serviceList").innerHTML = `<div class="small-muted">å…ˆä¿å­˜/é€‰æ‹©åŒ–å¦†å¸ˆï¼Œå†æ·»åŠ é¡¹ç›®ã€‚</div>`;
});
document.getElementById("btnAddService").addEventListener("click", async () => {
  const staffId = currentStaffId();
  if (!staffId) return alert("è¯·å…ˆä¿å­˜/é€‰æ‹©åŒ–å¦†å¸ˆ");
  const name = document.getElementById("svcName").value.trim();
  const price = Number(document.getElementById("svcPrice").value);
  if (!name) return alert("é¡¹ç›®åç§°å¿…å¡«");
  if (Number.isNaN(price) || price < 0) return alert("é‡‘é¢å¿…é¡»>=0");
  try {
    await upsertServiceCloud(staffId, { name, price });
    await loadAll();
    renderServiceListForCurrentStaff();
    document.getElementById("svcName").value = "";
    document.getElementById("svcPrice").value = "";
    showToast("é¡¹ç›®å·²æ·»åŠ ");
  } catch (e) {
    console.error(e);
    alert("æ·»åŠ å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
  }
});
document.getElementById("btnClearServiceInput").addEventListener("click", () => {
  document.getElementById("svcName").value = "";
  document.getElementById("svcPrice").value = "";
});

/********************
 * Invoice UI
 ********************/
function renderInvoiceBookingDropdown() {
  const sel = document.getElementById("invoiceBooking");
  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "ï¼ˆä¸ç»‘å®šé¢„çº¦ï¼‰";
  sel.appendChild(opt0);

  const list = [...DB.bookings].sort((a,b) => (a.startISO||"").localeCompare(b.startISO||""));
  list.forEach(b => {
    const st = staffById(b.staffId);
    const opt = document.createElement("option");
    opt.value = b.id;
    opt.textContent = `${b.date} ${b.startTime}-${b.endTime}ï½œ${b.custName}ï½œ${b.serviceName||""}ï½œ${st?st.name:"å‘˜å·¥å·²åˆ "}`;
    sel.appendChild(opt);
  });
}
function setInvoiceAutoInfo(bookingId, isNewDraft) {
  const info = document.getElementById("invoiceAutoInfo");
  if (!bookingId) { info.textContent = "æœªç»‘å®šé¢„çº¦ï¼šå»ºè®®ç»‘å®šé¢„çº¦è‡ªåŠ¨å¸¦å‡ºé¡¹ç›®é‡‘é¢ã€‚"; return; }
  const b = bookingById(bookingId);
  if (!b) { info.textContent = "é¢„çº¦ä¸å­˜åœ¨ï¼ˆå¯èƒ½å·²åˆ é™¤ï¼‰"; return; }
  const st = staffById(b.staffId);
  info.innerHTML = `å·²ç»‘å®šï¼š<span class="mono">${b.date} ${b.startTime}-${b.endTime}</span>ï½œå®¢æˆ· <span class="mono">${b.custName}</span>ï½œé¡¹ç›® <span class="mono">${b.serviceName||""}</span>ï½œé‡‘é¢ <span class="mono">${fmtMoney(b.servicePrice||0)}</span>ï½œå‘˜å·¥ <span class="mono">${st?st.name:"å‘˜å·¥å·²åˆ "}</span>`;
  if (isNewDraft) {
    const curTotal = document.getElementById("amountTotal").value;
    if (curTotal === "" || Number(curTotal) === 0) document.getElementById("amountTotal").value = Number(b.servicePrice||0);
    const curDeposit = document.getElementById("depositDue").value;
    if (curDeposit === "" || Number(curDeposit) === 0) document.getElementById("depositDue").value = Math.min(DEFAULT_DEPOSIT, Number(b.servicePrice||0));
  }
}
function recalcInvoicePreview() {
  const total = Number(document.getElementById("amountTotal").value || 0);
  let depositDue = Number(document.getElementById("depositDue").value || 0);
  depositDue = Math.max(0, Math.min(depositDue, total));
  document.getElementById("depositDue").value = depositDue;
  const balanceDue = Math.max(0, total - depositDue);
  document.getElementById("balanceDue").value = fmtMoney(balanceDue);

  const paid = Number(document.getElementById("amountPaid").value || 0);
  const stAuto = autoStatus(total, paid, depositDue);
  document.getElementById("statusHint").innerHTML = `è‡ªåŠ¨çŠ¶æ€ï¼š<span class="mono">${statusLabel(stAuto)}</span>`;
}
document.getElementById("invoiceBooking").addEventListener("change", () => {
  setInvoiceAutoInfo(document.getElementById("invoiceBooking").value, true);
  recalcInvoicePreview();
});
["amountTotal","depositDue","amountPaid"].forEach(id => document.getElementById(id).addEventListener("input", recalcInvoicePreview));
document.getElementById("btnQuickDeposit").addEventListener("click", () => {
  const total = Number(document.getElementById("amountTotal").value || 0);
  let depositDue = Number(document.getElementById("depositDue").value || 0);
  depositDue = Math.max(0, Math.min(depositDue, total));
  document.getElementById("amountPaid").value = depositDue;
  recalcInvoicePreview();
});
document.getElementById("btnQuickPaidAll").addEventListener("click", () => {
  const total = Number(document.getElementById("amountTotal").value || 0);
  document.getElementById("amountPaid").value = total;
  recalcInvoicePreview();
});

function openNewInvoice(prefillBookingId="") {
  document.getElementById("invoiceId").value = "";
  document.getElementById("invoiceBooking").value = prefillBookingId || "";
  document.getElementById("amountTotal").value = "";
  document.getElementById("depositDue").value = DEFAULT_DEPOSIT;
  document.getElementById("amountPaid").value = "";
  document.getElementById("payMethod").value = "å¾®ä¿¡";
  document.getElementById("invoiceStatus").value = "AUTO";
  document.getElementById("invoiceNote").value = "";
  document.getElementById("invoiceHistory").textContent = "æš‚æ— ";
  setInvoiceAutoInfo(prefillBookingId || "", true);
  recalcInvoicePreview();
  invoiceModal.show();
}
function openEditInvoice(id) {
  const inv = invoiceById(id);
  if (!inv) return;
  document.getElementById("invoiceId").value = inv.id;
  document.getElementById("invoiceBooking").value = inv.bookingId || "";
  document.getElementById("amountTotal").value = inv.amountTotal ?? 0;
  document.getElementById("depositDue").value = inv.depositDue ?? DEFAULT_DEPOSIT;
  document.getElementById("amountPaid").value = inv.amountPaid ?? 0;
  document.getElementById("payMethod").value = inv.payMethod || "å¾®ä¿¡";
  document.getElementById("invoiceStatus").value = inv.statusManual || "AUTO";
  document.getElementById("invoiceNote").value = inv.note || "";

  setInvoiceAutoInfo(inv.bookingId || "", false);
  recalcInvoicePreview();

  const h = Array.isArray(inv.history) ? inv.history : [];
  document.getElementById("invoiceHistory").innerHTML =
    h.length ? h.slice().reverse().slice(0,12).map(x =>
      `<div>â€¢ ${fmtDateTime(x.at)}ï½œ${x.action}ï½œåº”æ”¶ ${fmtMoney(x.amountTotal)}ï½œå®šé‡‘ ${fmtMoney(x.depositDue)}ï½œå·²æ”¶ ${fmtMoney(x.amountPaid)}ï½œ${x.statusFinalLabel}ï½œ${x.payMethod}</div>`
    ).join("") : "æš‚æ— ";

  invoiceModal.show();
}

document.getElementById("btnSaveInvoice").addEventListener("click", async () => {
  try {
    const id = document.getElementById("invoiceId").value || null;
    const bookingId = document.getElementById("invoiceBooking").value || "";
    const amountTotal = Number(document.getElementById("amountTotal").value);
    let depositDue = Number(document.getElementById("depositDue").value);
    const amountPaid = Number(document.getElementById("amountPaid").value || 0);
    const payMethod = document.getElementById("payMethod").value;
    const note = document.getElementById("invoiceNote").value.trim();
    const statusManual = document.getElementById("invoiceStatus").value; // AUTO or VOID

    if (Number.isNaN(amountTotal) || amountTotal < 0) return alert("åº”æ”¶æ€»é¢å¿…é¡»>=0");
    if (Number.isNaN(depositDue) || depositDue < 0) return alert("å®šé‡‘å¿…é¡»>=0");
    if (Number.isNaN(amountPaid) || amountPaid < 0) return alert("å·²æ”¶å¿…é¡»>=0");
    if (amountPaid > amountTotal + 0.00001) return alert("å·²æ”¶ä¸èƒ½å¤§äºåº”æ”¶æ€»é¢");

    depositDue = Math.max(0, Math.min(depositDue, amountTotal));
    const stAuto = autoStatus(amountTotal, amountPaid, depositDue);
    const statusFinal = (statusManual === "VOID") ? "VOID" : stAuto;

    const old = id ? invoiceById(id) : null;
    const history = old?.history ? [...old.history] : [];
    history.push({
      at: new Date().toISOString(),
      action: id ? "UPDATE" : "CREATE",
      amountTotal,
      depositDue,
      amountPaid,
      payMethod,
      statusManual,
      statusFinal,
      statusFinalLabel: statusLabel(statusFinal),
      note
    });

    const record = {
      id: id || uuid(),
      bookingId: bookingId || null,
      amountTotal,
      depositDue,
      amountPaid,
      payMethod,
      note,
      statusManual,
      statusFinal,
      history
    };

    await upsertInvoiceCloud(record);
    await loadAll();
    invoiceModal.hide();
    showToast(id ? "è´¦å•å·²æ›´æ–°" : "è´¦å•å·²æ–°å¢");
  } catch (e) {
    console.error(e);
    alert("ä¿å­˜å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
  }
});

async function deleteInvoice(id) {
  if (!confirm("ç¡®å®šåˆ é™¤è¯¥è´¦å•ï¼Ÿ")) return;
  try {
    await deleteInvoiceCloud(id);
    await loadAll();
    showToast("å·²åˆ é™¤");
  } catch (e) {
    console.error(e);
    alert("åˆ é™¤å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
  }
}

function invoiceDerivedInfo(inv) {
  let date = inv.date || "";
  let cust = inv.custName || "ï¼ˆæœªç»‘å®šé¢„çº¦ï¼‰";
  let service = inv.serviceName || "";
  let staffName = inv.staffName || "";
  let staff = null;

  if (inv.bookingId) {
    const b = bookingById(inv.bookingId);
    if (b) {
      date = b.date;
      cust = b.custName;
      service = b.serviceName || "";
      staff = staffById(b.staffId);
      staffName = staff ? staff.name : "ï¼ˆå‘˜å·¥å·²åˆ é™¤ï¼‰";
    } else {
      staffName = "ï¼ˆé¢„çº¦å·²åˆ é™¤ï¼‰";
    }
  }
  return { date, cust, service, staffName, staff };
}

function renderInvoices() {
  const q = (document.getElementById("invoiceSearch").value || "").trim().toLowerCase();
  const box = document.getElementById("invoiceCards");
  box.innerHTML = "";

  const list = [...DB.invoices].sort((a,b) => (b.created_at||"").localeCompare(a.created_at||""));

  const filtered = list.filter(inv => {
    const { date, cust, service, staffName } = invoiceDerivedInfo(inv);
    const badgeText = invoiceBadge(inv).text;
    const blob = `${date} ${cust} ${service} ${staffName} ${inv.note||""} ${badgeText}`.toLowerCase();
    return !q || blob.includes(q);
  });

  if (!filtered.length) { box.innerHTML = `<div class="small-muted">æš‚æ— è´¦å•</div>`; return; }

  filtered.forEach(inv => {
    const { date, cust, service, staffName, staff } = invoiceDerivedInfo(inv);
    const total = Number(inv.amountTotal || 0);
    const deposit = Math.max(0, Math.min(Number(inv.depositDue ?? DEFAULT_DEPOSIT), total));
    const paid = Number(inv.amountPaid || 0);

    const depositPaid = Math.min(paid, deposit);
    const balanceDue = Math.max(0, total - deposit);
    const balancePaid = Math.max(0, paid - deposit);
    const balanceUnpaid = Math.max(0, balanceDue - balancePaid);
    const unpaidAll = Math.max(0, total - paid);

    const badge = invoiceBadge(inv);
    const stFinal = inv.statusFinal || inv.status_final;
    const commission = (stFinal === "VOID") ? 0 : calcCommission(staff, total);

    const card = document.createElement("div");
    card.className = "card shadow-sm";
    card.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-semibold">${cust}</div>
            <div class="small-muted">${date || "-"}ï½œ${service || ""}ï½œ${staffName || "-"}</div>
          </div>
          <span class="pill ${badge.cls}">${badge.text}</span>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-4">
            <div class="small-muted">åº”æ”¶</div>
            <div class="mono">${fmtMoney(total)}</div>
          </div>
          <div class="col-4">
            <div class="small-muted">å·²æ”¶</div>
            <div class="mono">${fmtMoney(paid)}</div>
          </div>
          <div class="col-4">
            <div class="small-muted">æœªæ”¶</div>
            <div class="mono">${fmtMoney(unpaidAll)}</div>
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-4">
            <div class="small-muted">å®šé‡‘(åº”/æ”¶)</div>
            <div class="mono">${fmtMoney(deposit)} / ${fmtMoney(depositPaid)}</div>
          </div>
          <div class="col-4">
            <div class="small-muted">å°¾æ¬¾(åº”æ”¶)</div>
            <div class="mono">${fmtMoney(balanceDue)}</div>
          </div>
          <div class="col-4">
            <div class="small-muted">å°¾æ¬¾(æœªæ”¶)</div>
            <div class="mono">${fmtMoney(balanceUnpaid)}</div>
          </div>
        </div>

        <div class="small-muted mt-2">ææˆï¼š<span class="mono">${fmtMoney(commission)}</span></div>
        ${inv.note ? `<div class="small-muted mt-1">å¤‡æ³¨ï¼š${inv.note}</div>` : ""}

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-outline-primary flex-grow-1" data-act="edit" data-id="${inv.id}">ç¼–è¾‘</button>
          <button class="btn btn-outline-danger" data-act="del" data-id="${inv.id}">åˆ é™¤</button>
        </div>
      </div>
    `;
    box.appendChild(card);
  });

  box.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if (act === "edit") openEditInvoice(id);
      if (act === "del") deleteInvoice(id);
    });
  });
}
document.getElementById("invoiceSearch").addEventListener("input", renderInvoices);

/********************
 * Reports
 ********************/
function runReport() {
  const start = document.getElementById("repStart").value || "0000-01-01";
  const end = document.getElementById("repEnd").value || "9999-12-31";

  const filtered = DB.invoices.filter(inv => {
    const statusFinal = inv.statusFinal || inv.status_final;
    if (statusFinal === "VOID") return false;
    let d = inv.date || "";
    const bookingId = inv.bookingId || inv.booking_id;
    if (bookingId) {
      const b = bookingById(bookingId);
      d = b ? b.date : d;
    }
    return d >= start && d <= end;
  });

  let total = 0, paid = 0;
  let depositPaidSum = 0;
  let balanceUnpaidSum = 0;

  const staffAgg = new Map();
  const openList = [];

  filtered.forEach(inv => {
    const amt = Number(inv.amountTotal || inv.amount_total || 0);
    const pd = Number(inv.amountPaid || inv.amount_paid || 0);
    const deposit = Math.max(0, Math.min(Number(inv.depositDue ?? inv.deposit_due ?? DEFAULT_DEPOSIT), amt));

    total += amt;
    paid += pd;

    const depPaid = Math.min(pd, deposit);
    depositPaidSum += depPaid;

    const balanceDue = Math.max(0, amt - deposit);
    const balancePaid = Math.max(0, pd - deposit);
    const balanceUnpaid = Math.max(0, balanceDue - balancePaid);
    balanceUnpaidSum += balanceUnpaid;

    let staff = null, staffId = "unknown", staffName = "æœªè¯†åˆ«";
    const bookingId = inv.bookingId || inv.booking_id;
    if (bookingId) {
      const b = bookingById(bookingId);
      if (b) {
        staff = staffById(b.staffId);
        staffId = b.staffId || "unknown";
        staffName = staff ? staff.name : "ï¼ˆå‘˜å·¥å·²åˆ é™¤ï¼‰";
      }
    }
    const commission = calcCommission(staff, amt);

    if (!staffAgg.has(staffId)) staffAgg.set(staffId, { name: staffName, count: 0, total: 0, commission: 0 });
    const rec = staffAgg.get(staffId);
    rec.count += 1;
    rec.total += amt;
    rec.commission += commission;

    const unpaidAll = Math.max(0, amt - pd);
    if (unpaidAll > 0.00001) {
      let d = inv.date || "";
      let cust = "ï¼ˆæœªç»‘å®šé¢„çº¦ï¼‰";
      let svc = "";
      if (bookingId) {
        const b = bookingById(bookingId);
        if (b) { d = b.date; cust = b.custName; svc = b.serviceName || ""; }
      }
      openList.push({ d, cust, svc, unpaidAll, balanceUnpaid, id: inv.id });
    }
  });

  document.getElementById("repTotal").textContent = fmtMoney(total);
  document.getElementById("repPaid").textContent = fmtMoney(paid);
  document.getElementById("repUnpaid").textContent = fmtMoney(Math.max(0, total - paid));
  document.getElementById("repDepositPaid").textContent = fmtMoney(depositPaidSum);
  document.getElementById("repBalanceUnpaid").textContent = fmtMoney(balanceUnpaidSum);

  const staffBox = document.getElementById("repStaffCards");
  staffBox.innerHTML = "";
  const staffRows = [...staffAgg.values()].sort((a,b)=>b.total-a.total);
  if (!staffRows.length) staffBox.innerHTML = `<div class="small-muted">æš‚æ— æ•°æ®</div>`;
  else staffRows.forEach(r => {
    const div = document.createElement("div");
    div.className = "card shadow-sm";
    div.innerHTML = `
      <div class="card-body">
        <div class="fw-semibold">${r.name}</div>
        <div class="small-muted">å•æ•°ï¼š<span class="mono">${r.count}</span></div>
        <div class="small-muted">åº”æ”¶ï¼š<span class="mono">${fmtMoney(r.total)}</span></div>
        <div class="small-muted">ææˆï¼ˆæŒ‰åº”æ”¶ï¼‰ï¼š<span class="mono">${fmtMoney(r.commission)}</span></div>
      </div>
    `;
    staffBox.appendChild(div);
  });

  const openBox = document.getElementById("repOpenInvoices");
  openBox.innerHTML = "";
  if (!openList.length) openBox.innerHTML = `<div class="small-muted">æš‚æ— æœªç»“æ¸…è´¦å•</div>`;
  else {
    openList.sort((a,b)=>a.d.localeCompare(b.d)).forEach(x => {
      const div = document.createElement("div");
      div.className = "card shadow-sm";
      div.innerHTML = `
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div class="fw-semibold">${x.cust}</div>
            <div class="mono">æœªæ”¶ï¼š${fmtMoney(x.unpaidAll)}</div>
          </div>
          <div class="small-muted">${x.d} ${x.svc}</div>
          <div class="small-muted">æœªæ”¶å°¾æ¬¾ï¼š<span class="mono">${fmtMoney(x.balanceUnpaid)}</span></div>
          <button class="btn btn-outline-primary btn-sm mt-2" data-id="${x.id}">å»ç¼–è¾‘è´¦å•</button>
        </div>
      `;
      openBox.appendChild(div);
    });
    openBox.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        showPage("Invoices");
        openEditInvoice(btn.dataset.id);
      });
    });
  }
}

/********************
 * Upcoming list
 ********************/
function renderUpcoming() {
  const now = new Date();
  const today = now.toISOString().slice(0,10);
  document.getElementById("todayHint").textContent = `ä»Šå¤©ï¼š${today}`;

  const list = DB.bookings
    .filter(b => b.status !== "å·²å–æ¶ˆ")
    .sort((a,b) => (a.startISO||"").localeCompare(b.startISO||""))
    .filter(b => new Date(b.endISO) >= new Date(now.getTime() - 24*3600*1000))
    .slice(0, 10);

  const box = document.getElementById("upcomingList");
  box.innerHTML = "";

  if (!list.length) { box.innerHTML = `<div class="small-muted">æš‚æ— è¿‘æœŸé¢„çº¦</div>`; return; }

  list.forEach(b => {
    const st = staffById(b.staffId);
    const div = document.createElement("div");
    div.className = "card shadow-sm";
    div.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="fw-semibold">${b.custName}</div>
            <div class="small-muted">${b.date} ${b.startTime}-${b.endTime}ï½œ${b.serviceName||""}ï½œ${st?st.name:"å‘˜å·¥å·²åˆ "}</div>
          </div>
          <span class="pill ${b.status==="å·²å®Œæˆ"?"bg-success text-white":"bg-primary text-white"}">${b.status}</span>
        </div>
        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-outline-primary flex-grow-1" data-act="edit" data-id="${b.id}">ç¼–è¾‘é¢„çº¦</button>
          <button class="btn btn-outline-secondary flex-grow-1" data-act="inv" data-id="${b.id}">åšè´¦å•</button>
        </div>
      </div>
    `;
    box.appendChild(div);
  });

  box.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if (act === "edit") openEditBooking(id);
      if (act === "inv") openNewInvoice(id);
    });
  });
}

/********************
 * Refresh all
 ********************/
function refreshAll() {
  renderStaff();
  renderServiceListForCurrentStaff();
  renderInvoiceBookingDropdown();
  renderInvoices();
  refreshCalendar();
  renderUpcoming();

  fillStaffSelect(document.getElementById("staffSelect"), DB.staff[0]?.id ?? null);
  fillServiceSelectByStaff(document.getElementById("serviceSelect"), document.getElementById("staffSelect").value);

  const today = new Date().toISOString().slice(0,10);
  if (!document.getElementById("repStart").value) document.getElementById("repStart").value = today.slice(0,7) + "-01";
  if (!document.getElementById("repEnd").value) document.getElementById("repEnd").value = today;
}

/********************
 * Owner Lock (Mode B) - for Invoices & Reports
 ********************/
const LOCK_KEY = "owner_lock_pin_v1";
let __unlockGranted = false;
let __pendingPage = null;
function getSavedPin() { return localStorage.getItem(LOCK_KEY) || ""; }
function setSavedPin(pin) { localStorage.setItem(LOCK_KEY, pin); }
function clearSavedPin() { localStorage.removeItem(LOCK_KEY); }
function isValidPin(pin) { return /^[0-9]{4,6}$/.test(pin); }

function openLockModal({ mode, onSuccess, onCancel }) {
  const modalEl = document.getElementById("lockModal");
  const modal = new bootstrap.Modal(modalEl);
  const tip = document.getElementById("lockTip");
  const label = document.getElementById("lockLabel");
  const input = document.getElementById("lockPin");
  const err = document.getElementById("lockErr");

  err.classList.add("d-none"); err.textContent = ""; input.value = "";

  if (mode === "SET") { tip.textContent = "é¦–æ¬¡ä½¿ç”¨ï¼šè¯·è®¾ç½®è€æ¿å¯†ç ï¼ˆ4~6ä½æ•°å­—ï¼‰"; label.textContent = "è®¾ç½®å¯†ç ï¼ˆ4~6ä½æ•°å­—ï¼‰"; }
  else { tip.textContent = "è¿›å…¥è´¦å•/æŠ¥è¡¨éœ€è¦å¯†ç "; label.textContent = "è¾“å…¥å¯†ç ï¼ˆ4~6ä½æ•°å­—ï¼‰"; }

  const okBtn = document.getElementById("lockOk");
  const cancelBtn = document.getElementById("lockCancel");
  const resetBtn = document.getElementById("lockReset");

  function cleanup() { okBtn.onclick = null; cancelBtn.onclick = null; resetBtn.onclick = null; }

  okBtn.onclick = () => {
    const pin = (input.value || "").trim();
    if (!isValidPin(pin)) { err.textContent = "å¯†ç å¿…é¡»æ˜¯ 4~6 ä½æ•°å­—"; err.classList.remove("d-none"); return; }

    if (mode === "SET") {
      setSavedPin(pin); __unlockGranted = true; modal.hide(); cleanup(); onSuccess?.(); return;
    }

    const saved = getSavedPin();
    if (!saved) { modal.hide(); cleanup(); openLockModal({ mode: "SET", onSuccess, onCancel }); return; }
    if (pin !== saved) { err.textContent = "å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•"; err.classList.remove("d-none"); return; }

    __unlockGranted = true; modal.hide(); cleanup(); onSuccess?.();
  };

  cancelBtn.onclick = () => { modal.hide(); cleanup(); onCancel?.(); };
  resetBtn.onclick = () => {
    if (!confirm("ç¡®å®šè¦é‡è®¾å¯†ç å—ï¼Ÿï¼ˆå°†æ¸…é™¤æ—§å¯†ç ï¼‰")) return;
    clearSavedPin(); __unlockGranted = false;
    err.classList.add("d-none"); err.textContent = "";
    tip.textContent = "å·²æ¸…é™¤æ—§å¯†ç ï¼Œè¯·é‡æ–°è®¾ç½®"; label.textContent = "è®¾ç½®å¯†ç ï¼ˆ4~6ä½æ•°å­—ï¼‰";
  };

  modal.show();
  setTimeout(() => input.focus(), 250);
}

function requireOwnerUnlock(targetPageName) {
  if (__unlockGranted) return true;
  const saved = getSavedPin();
  const mode = saved ? "VERIFY" : "SET";
  __pendingPage = targetPageName;

  openLockModal({
    mode,
    onSuccess: () => {
      if (__pendingPage) { window.__showPageOriginal?.(__pendingPage); __pendingPage = null; }
    },
    onCancel: () => { __pendingPage = null; window.__showPageOriginal?.("Calendar"); }
  });
  return false;
}

(function hookShowPage() {
  window.__showPageOriginal = showPage;
  window.showPage = function(name) {
    if (name === "Invoices" || name === "Reports") {
      const ok = requireOwnerUnlock(name);
      if (!ok) return;
    }
    window.__showPageOriginal(name);
  };
})();

/********************
 * Buttons
 ********************/
document.getElementById("btnNewBooking").addEventListener("click", () => openNewBooking());
document.getElementById("btnNewInvoiceFromCal").addEventListener("click", () => openNewInvoice());
document.getElementById("btnNewInvoice").addEventListener("click", () => openNewInvoice());
document.getElementById("btnRunReport").addEventListener("click", runReport);

document.getElementById("btnSync").addEventListener("click", async () => {
  try {
    await loadAll();
    showToast("å·²åŒæ­¥");
  } catch (e) {
    console.error(e);
    alert("åŒæ­¥å¤±è´¥ï¼š" + (e?.message || "æœªçŸ¥é”™è¯¯"));
  }
});

document.getElementById("btnShopInfo").addEventListener("click", () => {
  document.getElementById("shopTitle").textContent = currentShop.name || "æˆ‘çš„åº—é“º";
  document.getElementById("shopCode").textContent = currentShop.join_code || "-";
  document.getElementById("shopIdText").textContent = currentShop.id;
  shopModal.show();
});
document.getElementById("btnCopyShopId").addEventListener("click", async () => {
  try {
    await navigator.clipboard.writeText(currentShop?.id || "");
    showToast("å·²å¤åˆ¶ shop_id");
  } catch { alert("å¤åˆ¶å¤±è´¥ï¼šè¯·æ‰‹åŠ¨é•¿æŒ‰å¤åˆ¶"); }
});

/********************
 * Calendar init
 ********************/
function initCalendarOnce() {
  if (calendar) return;
  calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
    initialView: "timeGridWeek",
    height: "auto",
    locale: "zh-cn",
    headerToolbar: { left: "prev,next today", center: "title", right: "" },
    selectable: true,
    select: (info) => {
      const date = info.startStr.slice(0,10);
      openNewBooking({ date, startTime: "09:00", endTime: "11:00" });
    },
    eventClick: (info) => openEditBooking(info.event.id)
  });
  calendar.render();
  document.getElementById("btnViewWeek").addEventListener("click", () => calendar.changeView("timeGridWeek"));
  document.getElementById("btnViewDay").addEventListener("click", () => calendar.changeView("timeGridDay"));
  document.getElementById("btnViewList").addEventListener("click", () => calendar.changeView("listWeek"));
}

/********************
 * Boot
 ********************/
(async function boot() {
  initCalendarOnce();
  showPage("Calendar");
  await loadShopMeta();
  await loadAll();
  showToast("å·²è¿›å…¥åº—é“ºï¼ˆäº‘åŒæ­¥ï¼‰");

  // è½»é‡è‡ªåŠ¨åˆ·æ–°ï¼šæ¯ 20 ç§’æ‹‰ä¸€æ¬¡
  setInterval(() => loadAll().catch(()=>{}), 20000);
})();
</script>
</body>
</html>
